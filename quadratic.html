<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parabola Sign Trainer - Progressive Learning</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        :root {
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --bg-hover: #334155;
            --accent-blue: #3b82f6;
            --accent-green: #10b981;
            --accent-red: #ef4444;
            --accent-yellow: #f59e0b;
            --accent-purple: #8b5cf6;
            --accent-pink: #ec4899;
            --accent-cyan: #06b6d4;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border: #334155;
        }

        @media (prefers-color-scheme: light) {
            :root {
                --bg-dark: #f8fafc;
                --bg-card: #ffffff;
                --bg-hover: #f1f5f9;
                --accent-blue: #2563eb;
                --accent-green: #059669;
                --accent-red: #dc2626;
                --accent-yellow: #d97706;
                --accent-purple: #7c3aed;
                --accent-pink: #db2777;
                --accent-cyan: #0891b2;
                --text-primary: #0f172a;
                --text-secondary: #475569;
                --border: #e2e8f0;
            }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 1rem;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Login Screen */
        .login-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 2rem;
        }

        .login-card {
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 24px;
            padding: 3rem;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
            animation: fadeIn 0.6s ease-out;
        }

        .qr-code-container {
            margin-top: 2rem;
            display: flex;
            justify-content: center;
        }

        .qr-code-box {
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 16px;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: fadeIn 0.8s ease-out 0.2s backwards;
        }

        .qr-toggle-btn {
            width: 100%;
            padding: 0.75rem;
            font-size: 0.95rem;
            font-weight: 600;
            background: linear-gradient(135deg, var(--accent-purple), var(--accent-pink));
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 1.5rem;
        }

        .qr-toggle-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(139, 92, 246, 0.4);
        }

        .qr-toggle-btn:active {
            transform: translateY(0);
        }

        .login-title {
            font-size: 2rem;
            font-weight: 700;
            text-align: center;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .login-subtitle {
            text-align: center;
            color: var(--text-secondary);
            margin-bottom: 2rem;
            font-family: 'Fira Code', monospace;
        }

        .login-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .login-tab {
            flex: 1;
            padding: 1rem;
            background: var(--bg-dark);
            border: 2px solid var(--border);
            border-radius: 12px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .login-tab.active {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
            color: white;
        }

        .login-form {
            display: none;
        }

        .login-form.active {
            display: block;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .form-input {
            width: 100%;
            padding: 1rem;
            background: var(--bg-dark);
            border: 2px solid var(--border);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 16px;
            font-family: 'Outfit', sans-serif;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .login-btn {
            width: 100%;
            padding: 1rem 2rem;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.125rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(59, 130, 246, 0.4);
        }

        .info-box {
            background: rgba(59, 130, 246, 0.1);
            border: 2px solid var(--accent-blue);
            border-radius: 12px;
            padding: 1rem;
            margin-top: 1.5rem;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .info-box strong {
            color: var(--accent-blue);
        }

        /* Teacher Dashboard */
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .dashboard-title {
            font-size: 2rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .logout-btn {
            padding: 0.75rem 1.5rem;
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .logout-btn:hover {
            background: var(--accent-red);
            border-color: var(--accent-red);
            color: white;
        }

        .students-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .student-card {
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 16px;
            padding: 1.5rem;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .student-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--accent-blue), var(--accent-purple));
        }

        .student-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .student-name {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .student-stage {
            display: inline-block;
            padding: 0.5rem 1rem;
            background: linear-gradient(135deg, var(--accent-purple), var(--accent-pink));
            color: white;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .student-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .student-stat {
            text-align: center;
            padding: 0.75rem;
            background: var(--bg-dark);
            border-radius: 8px;
        }

        .student-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            font-family: 'Fira Code', monospace;
            color: var(--accent-blue);
            display: block;
        }

        .student-stat-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .student-progress {
            margin-top: 1rem;
        }

        .student-progress-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
        }

        .student-progress-bar {
            height: 8px;
            background: var(--bg-dark);
            border-radius: 4px;
            overflow: hidden;
        }

        .student-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-green), var(--accent-cyan));
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 0.5rem;
            animation: pulse 2s infinite;
        }

        .status-active {
            background: var(--accent-green);
        }

        .status-inactive {
            background: var(--text-secondary);
            animation: none;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        header {
            text-align: center;
            margin-bottom: 2rem;
            animation: slideDown 0.6s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        h1 {
            font-size: clamp(2rem, 5vw, 3rem);
            font-weight: 700;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            font-family: 'Fira Code', monospace;
            color: var(--text-secondary);
            font-size: 1rem;
        }

        /* Stage Progress Section */
        .stage-section {
            background: linear-gradient(135deg, var(--accent-purple), var(--accent-pink));
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            color: white;
            box-shadow: 0 10px 40px rgba(139, 92, 246, 0.3);
            animation: fadeIn 0.6s ease-out;
        }

        .stage-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .stage-title {
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .stage-badge {
            background: rgba(255, 255, 255, 0.2);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-family: 'Fira Code', monospace;
            font-size: 0.875rem;
            backdrop-filter: blur(10px);
        }

        .stage-description {
            background: rgba(255, 255, 255, 0.15);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            backdrop-filter: blur(10px);
        }

        .progress-container {
            margin-top: 1rem;
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }

        .progress-bar {
            height: 24px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-green), var(--accent-cyan));
            border-radius: 12px;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 0.5rem;
            font-size: 0.75rem;
            font-weight: 700;
        }

        .stage-badges-container {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .mini-badge {
            text-align: center;
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            font-size: 0.75rem;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .mini-badge.completed {
            background: rgba(16, 185, 129, 0.3);
            border-color: var(--accent-green);
            transform: scale(1.05);
        }

        .mini-badge.current {
            background: rgba(255, 255, 255, 0.25);
            border-color: white;
            animation: pulse 2s infinite;
        }

        .mini-badge-icon {
            font-size: 1.5rem;
            display: block;
            margin-bottom: 0.25rem;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--bg-card);
            border: 2px solid var(--border);
            padding: 1.25rem;
            border-radius: 12px;
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            font-family: 'Fira Code', monospace;
            color: var(--accent-blue);
            display: block;
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        @media (max-width: 768px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: fadeIn 0.6s ease-out;
            position: relative;
        }

        .card h2 {
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            color: var(--accent-blue);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .equation-display {
            font-family: 'Fira Code', monospace;
            font-size: 1.5rem;
            text-align: center;
            padding: 1.5rem;
            background: var(--bg-dark);
            border-radius: 12px;
            margin-bottom: 1.5rem;
            border: 2px solid var(--accent-blue);
        }

        .canvas-container {
            position: relative;
            background: var(--bg-dark);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        #canvas {
            display: block;
            width: 100%;
            height: auto;
            border-radius: 8px;
        }

        .coefficient-question {
            background: var(--bg-dark);
            padding: 1.25rem;
            border-radius: 12px;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }

        .coefficient-question.hidden {
            display: none;
        }

        .coeff-label {
            font-family: 'Fira Code', monospace;
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
            display: block;
            color: var(--accent-yellow);
        }

        .options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.75rem;
        }

        .option-btn {
            font-family: 'Outfit', sans-serif;
            font-size: 16px;
            padding: 0.875rem;
            border: 2px solid var(--border);
            background: var(--bg-card);
            color: var(--text-primary);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 600;
        }

        .option-btn:hover {
            background: var(--bg-hover);
            transform: translateY(-2px);
        }

        .option-btn.selected {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
            color: white;
        }

        .option-btn.correct {
            background: var(--accent-green);
            border-color: var(--accent-green);
            color: white;
        }

        .option-btn.incorrect {
            background: var(--accent-red);
            border-color: var(--accent-red);
            color: white;
        }

        .option-btn:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }

        .submit-btn {
            font-family: 'Outfit', sans-serif;
            font-size: 1.125rem;
            font-weight: 600;
            padding: 1rem 2rem;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .submit-btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(59, 130, 246, 0.4);
        }

        .submit-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .next-btn {
            background: linear-gradient(135deg, var(--accent-green), var(--accent-blue));
        }

        .feedback {
            margin-top: 1.5rem;
            padding: 1.25rem;
            border-radius: 12px;
            font-weight: 500;
            display: none;
            animation: slideUp 0.4s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .feedback.show {
            display: block;
        }

        .feedback.success {
            background: rgba(16, 185, 129, 0.15);
            border: 2px solid var(--accent-green);
            color: var(--accent-green);
        }

        .feedback.error {
            background: rgba(239, 68, 68, 0.15);
            border: 2px solid var(--accent-red);
            color: var(--accent-red);
        }

        .hints {
            background: var(--bg-dark);
            padding: 1.5rem;
            border-radius: 12px;
            border-left: 4px solid var(--accent-yellow);
            margin-top: 1.5rem;
        }

        .hints h3 {
            color: var(--accent-yellow);
            margin-bottom: 1rem;
            font-size: 1.125rem;
        }

        .hints ul {
            list-style: none;
            padding: 0;
        }

        .hints li {
            padding: 0.5rem 0;
            padding-left: 1.5rem;
            position: relative;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .hints li:before {
            content: '‚ñ∏';
            position: absolute;
            left: 0;
            color: var(--accent-yellow);
        }

        /* Celebration Modal */
        .celebration-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        .celebration-modal.show {
            display: flex;
        }

        .celebration-content {
            background: linear-gradient(135deg, var(--accent-purple), var(--accent-pink));
            padding: 3rem;
            border-radius: 24px;
            text-align: center;
            max-width: 500px;
            color: white;
            animation: bounceIn 0.6s ease;
            position: relative;
        }

        .celebration-content.demotion {
            background: linear-gradient(135deg, var(--accent-red), var(--accent-yellow));
            animation: shakeIn 0.6s ease;
        }

        @keyframes shakeIn {
            0% {
                transform: scale(0) rotate(0deg);
                opacity: 0;
            }
            25% {
                transform: scale(1.1) rotate(-5deg);
            }
            50% {
                transform: scale(0.9) rotate(5deg);
            }
            75% {
                transform: scale(1.05) rotate(-2deg);
            }
            100% {
                transform: scale(1) rotate(0deg);
                opacity: 1;
            }
        }

        @keyframes bounceIn {
            0% {
                transform: scale(0);
                opacity: 0;
            }
            50% {
                transform: scale(1.1);
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .celebration-icon {
            font-size: 5rem;
            margin-bottom: 1rem;
            animation: rotate 1s ease;
        }

        @keyframes rotate {
            0% { transform: rotate(0deg) scale(0); }
            50% { transform: rotate(180deg) scale(1.2); }
            100% { transform: rotate(360deg) scale(1); }
        }

        .celebration-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }

        .celebration-message {
            font-size: 1.25rem;
            margin-bottom: 2rem;
            opacity: 0.9;
        }

        .celebration-btn {
            background: white;
            color: var(--accent-purple);
            padding: 1rem 2rem;
            border: none;
            border-radius: 12px;
            font-size: 1.125rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .celebration-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(255, 255, 255, 0.3);
        }

        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background: white;
            animation: confettiFall 3s linear infinite;
        }

        @keyframes confettiFall {
            0% {
                transform: translateY(-100px) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(500px) rotate(360deg);
                opacity: 0;
            }
        }

        .hidden {
            display: none !important;
        }

        @media (max-width: 768px) {
            .stats {
                grid-template-columns: repeat(2, 1fr);
            }

            .options {
                grid-template-columns: 1fr;
            }

            .stage-badges-container {
                grid-template-columns: repeat(3, 1fr);
            }

            .celebration-content {
                padding: 2rem;
                margin: 1rem;
            }

            .celebration-title {
                font-size: 2rem;
            }

            .students-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Alert Modal */
        .alert-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            animation: fadeIn 0.2s ease;
        }

        .alert-modal.show {
            display: flex;
        }

        .alert-content {
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 16px;
            padding: 2rem;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: bounceIn 0.4s ease;
        }

        .alert-icon {
            font-size: 3rem;
            text-align: center;
            margin-bottom: 1rem;
        }

        .alert-message {
            text-align: center;
            color: var(--text-primary);
            margin-bottom: 1.5rem;
            font-size: 1rem;
            line-height: 1.5;
        }

        .alert-btn {
            width: 100%;
            padding: 0.875rem 1.5rem;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .alert-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.4);
        }

        /* Confirm Modal */
        .confirm-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            animation: fadeIn 0.2s ease;
        }

        .confirm-modal.show {
            display: flex;
        }

        .confirm-content {
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 16px;
            padding: 2rem;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: bounceIn 0.4s ease;
        }

        .confirm-icon {
            font-size: 3rem;
            text-align: center;
            margin-bottom: 1rem;
        }

        .confirm-message {
            text-align: center;
            color: var(--text-primary);
            margin-bottom: 1.5rem;
            font-size: 1rem;
            line-height: 1.5;
        }

        .confirm-buttons {
            display: flex;
            gap: 1rem;
        }

        .confirm-btn {
            flex: 1;
            padding: 0.875rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .confirm-btn-cancel {
            background: var(--bg-dark);
            border: 2px solid var(--border);
            color: var(--text-primary);
        }

        .confirm-btn-cancel:hover {
            background: var(--bg-hover);
        }

        .confirm-btn-confirm {
            background: linear-gradient(135deg, var(--accent-red), var(--accent-yellow));
            color: white;
        }

        .confirm-btn-confirm:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(239, 68, 68, 0.4);
        }

        .clear-btn {
            padding: 0.75rem 1.5rem;
            background: var(--bg-card);
            border: 2px solid var(--accent-red);
            border-radius: 8px;
            color: var(--accent-red);
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            margin-left: 1rem;
        }

        .clear-btn:hover {
            background: var(--accent-red);
            color: white;
        }

        /* Groups Section */
        .groups-section {
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .groups-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .groups-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-blue);
        }

        .assign-btn {
            padding: 0.75rem 1.5rem;
            background: linear-gradient(135deg, var(--accent-green), var(--accent-cyan));
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .assign-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.4);
        }

        .groups-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1rem;
        }

        .group-card {
            background: var(--bg-dark);
            border: 2px solid var(--accent-purple);
            border-radius: 12px;
            padding: 1rem;
        }

        .group-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
            color: var(--accent-purple);
            font-weight: 700;
        }

        .group-members {
            list-style: none;
            padding: 0;
        }

        .group-member {
            padding: 0.5rem;
            background: var(--bg-card);
            border-radius: 6px;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }

        .waiting-state {
            background: var(--bg-card);
            border: 2px solid var(--accent-yellow);
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            text-align: center;
            animation: pulse 2s infinite;
        }

        .waiting-state-icon {
            font-size: 3rem;
            margin-bottom: 0.5rem;
        }

        .waiting-state-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--accent-yellow);
            margin-bottom: 0.5rem;
        }

        .waiting-state-message {
            color: var(--text-secondary);
        }

        .question-disabled-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(4px);
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10;
            padding: 2rem;
            text-align: center;
        }

        .question-disabled-overlay .overlay-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            animation: pulse 2s infinite;
        }

        .question-disabled-overlay .overlay-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-yellow);
            margin-bottom: 0.75rem;
        }

        .question-disabled-overlay .overlay-message {
            font-size: 1rem;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .group-info-box {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(236, 72, 153, 0.1));
            border: 2px solid var(--accent-purple);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .group-info-title {
            font-weight: 700;
            color: var(--accent-purple);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .group-members-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .group-member-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            background: var(--bg-card);
            border-radius: 6px;
        }

        /* Group Progress Chart Styles */
        .group-chart {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(139, 92, 246, 0.1));
            border: 2px solid var(--accent-blue);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .chart-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--accent-blue);
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .chart-bars {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .chart-bar-row {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .chart-label {
            min-width: 100px;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        .chart-bar-container {
            flex: 1;
            height: 40px;
            background: var(--bg-card);
            border-radius: 8px;
            position: relative;
            overflow: hidden;
            border: 1px solid var(--border);
        }

        .chart-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-purple), var(--accent-pink));
            border-radius: 8px;
            transition: width 0.5s ease-out;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 0.75rem;
            font-weight: 700;
            color: white;
            font-size: 0.9rem;
            min-width: 60px;
        }

        .chart-stage-indicator {
            min-width: 120px;
            text-align: right;
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .chart-stage-icon {
            font-size: 1.5rem;
            margin-right: 0.25rem;
        }

        .member-name {
            font-weight: 600;
        }

        .member-progress {
            font-size: 0.875rem;
            color: var(--accent-cyan);
            font-family: 'Fira Code', monospace;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-screen">
        <div class="login-card">
            <h1 class="login-title">üéØ Parabola Trainer</h1>
            <p class="login-subtitle">Choose your role to begin</p>

            <button class="qr-toggle-btn" onclick="toggleQRCode()" id="qrToggleBtn">
                üì± Show QR Code
            </button>

            <div class="login-tabs">
                <div class="login-tab active" onclick="switchTab('student')">
                    üë®‚Äçüéì Student
                </div>
                <div class="login-tab" onclick="switchTab('teacher')">
                    üë©‚Äçüè´ Teacher
                </div>
            </div>

            <!-- Student Login -->
            <div id="studentLogin" class="login-form active">
                <div class="form-group">
                    <label class="form-label">Your Name</label>
                    <input type="text" id="studentName" class="form-input" placeholder="Enter your full name" maxlength="30">
                </div>
                <button class="login-btn" onclick="studentLogin()">Start Learning</button>
                <div class="info-box">
                    <strong>üëã Students:</strong> Enter your name to start the parabola learning journey. Your teacher will be able to see your progress in real-time!
                </div>
            </div>

            <!-- Teacher Login -->
            <div id="teacherLogin" class="login-form">
                <div class="form-group">
                    <label class="form-label">Teacher Password</label>
                    <input type="password" id="teacherPassword" class="form-input" placeholder="Enter teacher password">
                </div>
                <button class="login-btn" onclick="teacherLogin()">View Dashboard</button>
                <div class="info-box">
                    <strong>üë©‚Äçüè´ Teachers:</strong> Enter your teacher password to access the dashboard and monitor student progress in real-time.
                </div>
            </div>
        </div>

        <!-- QR Code Section (hidden by default) -->
        <div class="qr-code-container" id="qrCodeContainer" style="display: none;">
            <div class="qr-code-box">
                <h3 style="margin-bottom: 0.75rem; color: var(--text-primary); font-size: 1rem;">üì± Scan to Join</h3>
                <div id="qrcode" style="background: white; padding: 0.75rem; border-radius: 8px; display: inline-block;"></div>
                <p style="margin-top: 0.75rem; font-size: 0.875rem; color: var(--text-secondary);">Scan this QR code with your mobile device</p>
            </div>
        </div>
    </div>

    <!-- Teacher Dashboard -->
    <div id="teacherDashboard" class="container hidden">
        <div class="dashboard-header">
            <h1 class="dashboard-title">üë©‚Äçüè´ Teacher Dashboard</h1>
            <div>
                <button class="clear-btn" onclick="confirmClearAllStudents()">üóëÔ∏è Clear All Students</button>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
        </div>

        <!-- Groups Section -->
        <div class="groups-section">
            <div class="groups-header">
                <h2 class="groups-title">üë• Student Groups</h2>
                <div style="display: flex; gap: 0.75rem;">
                    <button class="assign-btn" onclick="toggleGroupChart()" id="chartToggleBtn">üìä Show Progress Chart</button>
                    <button class="assign-btn" onclick="autoAssignGroups()">üé≤ Auto-Assign Groups</button>
                </div>
            </div>

            <!-- Progress Chart (hidden by default) -->
            <div id="groupProgressChart" class="group-chart" style="display: none;">
                <h3 class="chart-title">üìä Group Progress Overview</h3>
                <div id="chartBars" class="chart-bars"></div>
            </div>

            <div id="groupsContainer" class="groups-grid"></div>
            <div id="noGroupsMessage" class="empty-state" style="padding: 2rem;">
                <p style="color: var(--text-secondary);">No groups assigned yet. Click "Auto-Assign Groups" to create groups automatically (2 students per group, or 3 if odd number).</p>
            </div>
        </div>

        <div class="stats">
            <div class="stat-card">
                <span class="stat-value" id="dashTotalStudents">0</span>
                <span class="stat-label">Active Students</span>
            </div>
            <div class="stat-card">
                <span class="stat-value" id="dashAvgStage">0</span>
                <span class="stat-label">Avg Stage</span>
            </div>
            <div class="stat-card">
                <span class="stat-value" id="dashAvgAccuracy">0%</span>
                <span class="stat-label">Avg Accuracy</span>
            </div>
            <div class="stat-card">
                <span class="stat-value" id="dashTotalQuestions">0</span>
                <span class="stat-label">Total Questions</span>
            </div>
        </div>

        <div id="studentsContainer" class="students-grid"></div>

        <div id="emptyState" class="empty-state">
            <div class="empty-state-icon">üìö</div>
            <h2>No Students Yet</h2>
            <p>Students will appear here once they log in and start learning</p>
        </div>
    </div>

    <!-- Student Learning Interface -->
    <div id="studentInterface" class="container hidden">
        <header>
            <h1>üéØ Parabola Sign Trainer</h1>
            <p class="subtitle">Progressive Learning Journey - <span id="studentNameDisplay"></span> <button class="logout-btn" onclick="logout()" style="margin-left: 1rem; padding: 0.5rem 1rem; font-size: 0.875rem;">Logout</button></p>
        </header>

        <!-- Group Info -->
        <div class="group-info-box" id="groupInfoBox" style="display: none;">
            <div class="group-info-title">
                <span>üë•</span>
                <span>Your Group - Work Together!</span>
            </div>
            <div class="group-members-list" id="groupMembersList"></div>
            <p style="margin-top: 0.75rem; font-size: 0.875rem; color: var(--text-secondary);">
                üí° <strong>Team Goal:</strong> All members must answer 5 correct questions together to advance to the next stage!
            </p>
        </div>

        <!-- Waiting State -->
        <div class="waiting-state" id="waitingState" style="display: none;">
            <div class="waiting-state-icon">‚è≥</div>
            <div class="waiting-state-title">Great Job! Now Help Your Teammate!</div>
            <div class="waiting-state-message">
                You've completed your 5 correct answers! üéâ<br>
                Help your group members understand the concepts so you can advance together!
            </div>
        </div>

        <!-- Stage Progress -->
        <div class="stage-section">
            <div class="stage-header">
                <div class="stage-title">
                    <span id="stageIcon">üå±</span>
                    <span id="stageName">Stage 1: Beginner</span>
                </div>
                <div class="stage-badge" id="stageBadge">Level 1/7</div>
            </div>
            <div class="stage-description" id="stageDescription">
                Learn to identify the sign of coefficient 'a' - Does the parabola open upward or downward?
            </div>
            <div class="progress-container">
                <div class="progress-label">
                    <span>Progress to Next Stage</span>
                    <span id="progressText">0/5 correct</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%">
                        <span id="progressPercent"></span>
                    </div>
                </div>
            </div>
            <div class="stage-badges-container">
                <div class="mini-badge current" id="badge1">
                    <div class="mini-badge-icon">üå±</div>
                    <div>Stage 1</div>
                </div>
                <div class="mini-badge" id="badge2">
                    <div class="mini-badge-icon">üåø</div>
                    <div>Stage 2</div>
                </div>
                <div class="mini-badge" id="badge3">
                    <div class="mini-badge-icon">üå≥</div>
                    <div>Stage 3</div>
                </div>
                <div class="mini-badge" id="badge4">
                    <div class="mini-badge-icon">‚≠ê</div>
                    <div>Stage 4</div>
                </div>
                <div class="mini-badge" id="badge5">
                    <div class="mini-badge-icon">üèÜ</div>
                    <div>Stage 5</div>
                </div>
                <div class="mini-badge" id="badge6">
                    <div class="mini-badge-icon">üìç</div>
                    <div>Stage 6</div>
                </div>
                <div class="mini-badge" id="badge7">
                    <div class="mini-badge-icon">üéØ</div>
                    <div>Stage 7</div>
                </div>
            </div>
        </div>

        <div class="stats">
            <div class="stat-card">
                <span class="stat-value" id="totalQuestions">0</span>
                <span class="stat-label">Questions</span>
            </div>
            <div class="stat-card">
                <span class="stat-value" id="correctAnswers">0</span>
                <span class="stat-label">Correct</span>
            </div>
            <div class="stat-card">
                <span class="stat-value" id="accuracy">0%</span>
                <span class="stat-label">Accuracy</span>
            </div>
            <div class="stat-card">
                <span class="stat-value" id="currentStage">Stage 1</span>
                <span class="stat-label">Current Level</span>
            </div>
        </div>

        <div class="main-grid">
            <div class="card">
                <h2>üìä Graph</h2>
                <div class="equation-display" id="equationDisplay">
                    y = ax¬≤ + bx + c
                </div>
                <div class="canvas-container">
                    <canvas id="canvas" width="600" height="600"></canvas>
                </div>
            </div>

            <div class="card" id="questionCard">
                <h2>‚ùì Identify the Signs</h2>

                <!-- Waiting Overlay (shown when student completes 5/5 in group mode) -->
                <div class="question-disabled-overlay" id="questionDisabledOverlay" style="display: none;">
                    <div class="overlay-icon">‚è≥</div>
                    <div class="overlay-title">Great Job! You're Done! üéâ</div>
                    <div class="overlay-message">
                        You've completed your 5 correct answers!<br>
                        <strong>Now help your teammates understand the concepts.</strong><br>
                        You'll advance to the next stage together when everyone completes their 5 questions!
                    </div>
                </div>

                <div class="coefficient-question" id="questionA">
                    <label class="coeff-label">Sign of a:</label>
                    <div class="options">
                        <button class="option-btn" data-coeff="a" data-value="+">Positive (+)</button>
                        <button class="option-btn" data-coeff="a" data-value="0">Zero (0)</button>
                        <button class="option-btn" data-coeff="a" data-value="-">Negative (‚àí)</button>
                    </div>
                </div>

                <div class="coefficient-question hidden" id="questionC">
                    <label class="coeff-label">Sign of c:</label>
                    <div class="options">
                        <button class="option-btn" data-coeff="c" data-value="+">Positive (+)</button>
                        <button class="option-btn" data-coeff="c" data-value="0">Zero (0)</button>
                        <button class="option-btn" data-coeff="c" data-value="-">Negative (‚àí)</button>
                    </div>
                </div>

                <div class="coefficient-question hidden" id="questionDelta" style="border: 2px solid var(--accent-purple); background: rgba(139, 92, 246, 0.1);">
                    <label class="coeff-label" style="color: var(--accent-purple);">Sign of Œî (b¬≤ - 4ac):</label>
                    <div class="options">
                        <button class="option-btn" data-coeff="delta" data-value="+">Positive (+)</button>
                        <button class="option-btn" data-coeff="delta" data-value="0">Zero (0)</button>
                        <button class="option-btn" data-coeff="delta" data-value="-">Negative (ÔøΩÔøΩÔøΩ)</button>
                    </div>
                </div>

                <div class="coefficient-question hidden" id="questionAxis" style="border: 2px solid var(--accent-cyan); background: rgba(6, 182, 212, 0.1);">
                    <label class="coeff-label" style="color: var(--accent-cyan);">Sign of Axis of Symmetry (x-coordinate of vertex):</label>
                    <div class="options">
                        <button class="option-btn" data-coeff="axis" data-value="+">Positive (+)</button>
                        <button class="option-btn" data-coeff="axis" data-value="0">Zero (0)</button>
                        <button class="option-btn" data-coeff="axis" data-value="-">Negative (‚àí)</button>
                    </div>
                </div>

                <div class="coefficient-question hidden" id="questionB">
                    <label class="coeff-label">Sign of b:</label>
                    <div class="options">
                        <button class="option-btn" data-coeff="b" data-value="+">Positive (+)</button>
                        <button class="option-btn" data-coeff="b" data-value="0">Zero (0)</button>
                        <button class="option-btn" data-coeff="b" data-value="-">Negative (‚àí)</button>
                    </div>
                </div>

                <div class="coefficient-question hidden" id="questionVertexX" style="border: 2px solid var(--accent-pink); background: rgba(236, 72, 153, 0.1);">
                    <label class="coeff-label" style="color: var(--accent-pink);">Sign of Vertex x-coordinate:</label>
                    <div class="options">
                        <button class="option-btn" data-coeff="vertex-x" data-value="+">Positive (+)</button>
                        <button class="option-btn" data-coeff="vertex-x" data-value="0">Zero (0)</button>
                        <button class="option-btn" data-coeff="vertex-x" data-value="-">Negative (‚àí)</button>
                    </div>
                </div>

                <div class="coefficient-question hidden" id="questionVertexY" style="border: 2px solid var(--accent-green); background: rgba(16, 185, 129, 0.1);">
                    <label class="coeff-label" style="color: var(--accent-green);">Sign of Vertex y-coordinate:</label>
                    <div class="options">
                        <button class="option-btn" data-coeff="vertex-y" data-value="+">Positive (+)</button>
                        <button class="option-btn" data-coeff="vertex-y" data-value="0">Zero (0)</button>
                        <button class="option-btn" data-coeff="vertex-y" data-value="-">Negative (‚àí)</button>
                    </div>
                </div>

                <button class="submit-btn" id="submitBtn" onclick="checkAnswer()">Check Answer</button>
                <button class="submit-btn next-btn" id="nextBtn" onclick="generateNewQuestion()" style="display: none;">Next Question</button>

                <div class="feedback" id="feedback"></div>

                <div class="hints">
                    <h3 id="hintsTitle">üí° Quick Tips - Stage 1</h3>
                    <ul id="hintsList">
                        <li><strong>a positive:</strong> Parabola opens upward (‚à™) - like a smile</li>
                        <li><strong>a negative:</strong> Parabola opens downward (‚à©) - like a frown</li>
                        <li>Look at the direction the parabola opens!</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Celebration Modal -->
    <div class="celebration-modal" id="celebrationModal">
        <div class="celebration-content">
            <div class="celebration-icon" id="celebrationIcon">üéâ</div>
            <div class="celebration-title" id="celebrationTitle">Stage Complete!</div>
            <div class="celebration-message" id="celebrationMessage">
                Congratulations! You've mastered this stage.
            </div>
            <button class="celebration-btn" id="celebrationBtn" onclick="advanceStage()">Continue to Next Stage</button>
        </div>
    </div>

    <!-- Alert Modal -->
    <div class="alert-modal" id="alertModal">
        <div class="alert-content">
            <div class="alert-icon" id="alertIcon">‚ö†Ô∏è</div>
            <div class="alert-message" id="alertMessage"></div>
            <button class="alert-btn" id="alertBtn" onclick="closeAlert()">OK</button>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div class="confirm-modal" id="confirmModal">
        <div class="confirm-content">
            <div class="confirm-icon" id="confirmIcon">‚ö†Ô∏è</div>
            <div class="confirm-message" id="confirmMessage"></div>
            <div class="confirm-buttons">
                <button class="confirm-btn confirm-btn-cancel" onclick="closeConfirm()">Cancel</button>
                <button class="confirm-btn confirm-btn-confirm" id="confirmBtn">Confirm</button>
            </div>
        </div>
    </div>

    <script>
        // ==================== FIREBASE CONFIGURATION ====================
        const firebaseConfig = {
            apiKey: "AIzaSyCnLjEl9g8WqzZdnkR4SOLj6RJRJfZUZ4E",
            authDomain: "ndc-quadratic.firebaseapp.com",
            databaseURL: "https://ndc-quadratic-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "ndc-quadratic",
            storageBucket: "ndc-quadratic.firebasestorage.app",
            messagingSenderId: "503928329288",
            appId: "1:503928329288:web:1b8240ed801e66a168747d",
            measurementId: "G-3PWSBP0RB4"
        };

        // Initialize Firebase
        let database;
        try {
            firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            console.log("‚úÖ Firebase initialized successfully!");
            console.log("Database URL:", firebaseConfig.databaseURL);
        } catch (error) {
            console.error("‚ùå Firebase initialization error:", error);
            showAlert("Firebase is not configured. Please add your Firebase configuration in the script section.");
        }

        // ==================== GLOBAL VARIABLES ====================
        let currentUser = null;
        let currentRole = null;
        let studentId = null;
        let studentDataListener = null;
        let studentDataInitialized = false;
        let studentExistenceCheckInterval = null;
        let currentGroupId = null;
        let groupDataListener = null;
        let lastKnownGroupStage = null; // Track the last stage to detect changes

        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        let currentQuestion = {
            a: 0,
            b: 0,
            c: 0
        };

        let userAnswers = {
            a: null,
            b: null,
            c: null,
            delta: null,
            axis: null
        };

        let stats = {
            total: 0,
            correct: 0
        };

        let progression = {
            currentStage: 1,
            stageProgress: 0,
            stageTarget: 5,
            completedStages: []
        };

        const stages = {
            1: {
                name: "Stage 1: Beginner",
                icon: "üå±",
                description: "Learn to identify the sign of coefficient 'a' - Does the parabola open upward or downward?",
                tests: ['a'],
                hints: [
                    "<strong>a positive:</strong> Parabola opens upward (‚à™) - like a smile",
                    "<strong>a negative:</strong> Parabola opens downward (‚à©) - like a frown",
                    "Look at the direction the parabola opens!"
                ]
            },
            2: {
                name: "Stage 2: Explorer",
                icon: "üåø",
                description: "Now identify both 'a' and 'c' - Learn where the parabola crosses the y-axis!",
                tests: ['a', 'c'],
                hints: [
                    "<strong>a:</strong> Opens upward if positive (‚à™), downward if negative (‚à©)",
                    "<strong>c:</strong> Y-intercept (where graph crosses y-axis) üü†",
                    "c is positive if the orange dot is above the x-axis",
                    "c is negative if the orange dot is below the x-axis"
                ]
            },
            3: {
                name: "Stage 3: Investigator",
                icon: "üå≥",
                description: "Master 'a', 'c', and the discriminant Œî - Count the x-intercepts!",
                tests: ['a', 'c', 'delta'],
                hints: [
                    "<strong>Œî > 0:</strong> Two x-intercepts (red dots) üî¥üî¥",
                    "<strong>Œî = 0:</strong> One x-intercept (touches x-axis) üî¥",
                    "<strong>Œî < 0:</strong> No x-intercepts (doesn't cross x-axis)",
                    "<strong>c:</strong> Y-intercept üü†",
                    "Count the red dots to determine Œî's sign!"
                ]
            },
            4: {
                name: "Stage 4: Expert",
                icon: "‚≠ê",
                description: "Add axis of symmetry - Where is the vertex located horizontally?",
                tests: ['a', 'c', 'delta', 'axis'],
                hints: [
                    "<strong>Axis > 0:</strong> Vertex üü£ is on the right side of y-axis",
                    "<strong>Axis = 0:</strong> Vertex üü£ is on the y-axis",
                    "<strong>Axis < 0:</strong> Vertex üü£ is on the left side of y-axis",
                    "<strong>Œî:</strong> Count the red dots üî¥",
                    "The purple vertex shows the axis of symmetry!"
                ]
            },
            5: {
                name: "Stage 5: Master",
                icon: "üèÜ",
                description: "Complete challenge - All coefficients! You're a parabola expert now!",
                tests: ['a', 'b', 'c', 'delta', 'axis'],
                hints: [
                    "<strong>a:</strong> Opens upward (+) or downward (‚àí)",
                    "<strong>b:</strong> If vertex üü£ on right & opens up, b is negative",
                    "<strong>b:</strong> If vertex üü£ on left & opens up, b is positive",
                    "<strong>c:</strong> Y-intercept üü† position",
                    "<strong>Œî:</strong> Number of red dots üî¥",
                    "<strong>Axis:</strong> Vertex üü£ horizontal position"
                ]
            },
            6: {
                name: "Stage 6: Vertex X-Master",
                icon: "üìç",
                description: "Find the x-coordinate of the vertex - Where is the turning point horizontally?",
                tests: ['a', 'c', 'delta', 'axis', 'vertex-x'],
                hints: [
                    "<strong>Vertex x-coordinate:</strong> Look at the purple vertex üü£",
                    "<strong>x > 0:</strong> Vertex is on the right side of y-axis",
                    "<strong>x = 0:</strong> Vertex is on the y-axis",
                    "<strong>x < 0:</strong> Vertex is on the left side of y-axis",
                    "<strong>Axis of symmetry:</strong> Same as vertex x-coordinate!",
                    "The vertex x-coordinate is calculated as: -b/(2a)"
                ]
            },
            7: {
                name: "Stage 7: Vertex Y-Champion",
                icon: "üéØ",
                description: "Find the y-coordinate of the vertex - Where is the turning point vertically?",
                tests: ['a', 'c', 'delta', 'axis', 'vertex-x', 'vertex-y'],
                hints: [
                    "<strong>Vertex y-coordinate:</strong> Look at the purple vertex üü£ height",
                    "<strong>y > 0:</strong> Vertex is above the x-axis",
                    "<strong>y = 0:</strong> Vertex is on the x-axis",
                    "<strong>y < 0:</strong> Vertex is below the x-axis",
                    "<strong>Tip:</strong> Substitute x-coordinate back into y = ax¬≤ + bx + c",
                    "If parabola opens up, vertex is the minimum point",
                    "If parabola opens down, vertex is the maximum point"
                ]
            }
        };

        // ==================== ALERT MODAL FUNCTIONS ====================
        function showAlert(message, icon = '‚ö†Ô∏è') {
            const modal = document.getElementById('alertModal');
            const messageEl = document.getElementById('alertMessage');
            const iconEl = document.getElementById('alertIcon');

            messageEl.textContent = message;
            iconEl.textContent = icon;
            modal.classList.add('show');
        }

        function closeAlert() {
            const modal = document.getElementById('alertModal');
            modal.classList.remove('show');
        }

        // ==================== CONFIRM MODAL FUNCTIONS ====================
        function showConfirm(message, onConfirm, icon = '‚ö†Ô∏è') {
            const modal = document.getElementById('confirmModal');
            const messageEl = document.getElementById('confirmMessage');
            const iconEl = document.getElementById('confirmIcon');
            const confirmBtn = document.getElementById('confirmBtn');

            messageEl.textContent = message;
            iconEl.textContent = icon;
            modal.classList.add('show');

            // Remove old event listeners and add new one
            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);

            newConfirmBtn.onclick = () => {
                closeConfirm();
                onConfirm();
            };
        }

        function closeConfirm() {
            const modal = document.getElementById('confirmModal');
            modal.classList.remove('show');
        }

        // ==================== LOGIN FUNCTIONS ====================
        function switchTab(role) {
            document.querySelectorAll('.login-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.login-form').forEach(form => form.classList.remove('active'));

            if (role === 'student') {
                document.querySelectorAll('.login-tab')[0].classList.add('active');
                document.getElementById('studentLogin').classList.add('active');
            } else {
                document.querySelectorAll('.login-tab')[1].classList.add('active');
                document.getElementById('teacherLogin').classList.add('active');
            }
        }

        function studentLogin() {
            const name = document.getElementById('studentName').value.trim();

            if (!name) {
                showAlert('Please enter your name', 'üìù');
                return;
            }

            if (!database) {
                showAlert('Firebase is not configured. Please check the console.');
                return;
            }

            currentUser = name;
            currentRole = 'student';
            studentId = name.toLowerCase().replace(/\s+/g, '_');
            studentDataInitialized = false;
            lastKnownGroupStage = null; // Reset stage tracking on login

            console.log("üìù Student logging in:", name, "ID:", studentId);

            // Initialize student in Firebase
            const studentRef = database.ref('students/' + studentId);
            studentRef.update({
                name: name,
                currentStage: 1,
                stageProgress: 0,
                totalQuestions: 0,
                correctAnswers: 0,
                lastActive: firebase.database.ServerValue.TIMESTAMP,
                isActive: true
            }).then(() => {
                console.log("‚úÖ Student data written to Firebase successfully!");
                studentDataInitialized = true;
            }).catch((error) => {
                console.error("‚ùå Error writing student data:", error);
                showAlert("Error saving student data: " + error.message);
            });

            // Load student data
            loadStudentData();

            // Load group data
            loadGroupData();

            // Hide login, show student interface
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('studentInterface').classList.remove('hidden');
            document.getElementById('studentNameDisplay').textContent = name;

            // Start heartbeat
            startHeartbeat();

            // Start periodic existence check (important for mobile browsers)
            startStudentExistenceCheck();

            // Initialize game
            updateStageUI();
            generateNewQuestion();
        }

        function teacherLogin() {
            const password = document.getElementById('teacherPassword').value;

            if (password !== 'teacher123') {
                showAlert('Incorrect password!', 'üîí');
                return;
            }

            if (!database) {
                showAlert('Firebase is not configured. Please check the console.');
                return;
            }

            currentRole = 'teacher';

            // Hide login, show dashboard
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('teacherDashboard').classList.remove('hidden');

            // Start listening for student updates
            listenForStudents();

            // Start listening for groups
            listenForGroups();
        }

        function logout() {
            if (currentRole === 'student' && studentId) {
                // Clear the existence check interval
                if (studentExistenceCheckInterval) {
                    clearInterval(studentExistenceCheckInterval);
                    studentExistenceCheckInterval = null;
                }

                // Remove Firebase listener
                if (studentDataListener && database) {
                    const studentRef = database.ref('students/' + studentId);
                    studentRef.off('value', studentDataListener);
                    studentDataListener = null;
                }

                // Mark student as inactive (only if data still exists)
                if (database) {
                    database.ref('students/' + studentId).update({
                        isActive: false
                    }).catch(() => {
                        // Silently catch error if student data was already deleted
                    });
                }
            }

            // Reset state
            currentUser = null;
            currentRole = null;
            studentId = null;
            studentDataInitialized = false;

            // Show login screen
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('studentInterface').classList.add('hidden');
            document.getElementById('teacherDashboard').classList.add('hidden');
        }

        // ==================== FIREBASE SYNC FUNCTIONS ====================
        function startHeartbeat() {
            // Update last active timestamp every 30 seconds
            setInterval(() => {
                if (studentId && database) {
                    database.ref('students/' + studentId).update({
                        lastActive: firebase.database.ServerValue.TIMESTAMP,
                        isActive: true
                    });
                }
            }, 30000);
        }

        function startStudentExistenceCheck() {
            // Check every 3 seconds if student data still exists
            // This works reliably on mobile browsers even when Firebase listeners are throttled
            studentExistenceCheckInterval = setInterval(() => {
                if (studentId && database && currentRole === 'student' && studentDataInitialized) {
                    const studentRef = database.ref('students/' + studentId);
                    studentRef.once('value', (snapshot) => {
                        if (!snapshot.exists()) {
                            console.log("‚ö†Ô∏è Student data was removed (detected by polling) - logging out...");
                            // Clear the interval first to prevent multiple triggers
                            if (studentExistenceCheckInterval) {
                                clearInterval(studentExistenceCheckInterval);
                                studentExistenceCheckInterval = null;
                            }
                            showAlert('You have been logged out by the teacher. Please log in again to continue.', 'üö™');
                            setTimeout(() => {
                                logout();
                            }, 2000);
                        }
                    }).catch((error) => {
                        console.error("Error checking student existence:", error);
                    });
                }
            }, 3000); // Check every 3 seconds
        }

        function saveStudentProgress() {
            if (!studentId || !database) return;

            const studentRef = database.ref('students/' + studentId);
            studentRef.update({
                currentStage: progression.currentStage,
                stageProgress: progression.stageProgress,
                totalQuestions: stats.total,
                correctAnswers: stats.correct,
                lastActive: firebase.database.ServerValue.TIMESTAMP,
                isActive: true
            });
        }

        function loadStudentData() {
            if (!studentId || !database) return;

            const studentRef = database.ref('students/' + studentId);
            studentRef.once('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    stats.total = data.totalQuestions || 0;
                    stats.correct = data.correctAnswers || 0;
                    currentGroupId = data.groupId || null;

                    updateStats();
                }
            });

            // Listen for deletion - if student data is removed, log them out
            studentDataListener = studentRef.on('value', (snapshot) => {
                // Only check for deletion if student was already initialized
                if (!snapshot.exists() && currentRole === 'student' && studentDataInitialized) {
                    console.log("‚ö†Ô∏è Student data was removed - logging out...");
                    showAlert('You have been logged out by the teacher. Please log in again to continue.', 'üö™');
                    setTimeout(() => {
                        logout();
                    }, 2000);
                }

                // Check if group assignment changed
                const data = snapshot.val();
                if (data && data.groupId && data.groupId !== currentGroupId) {
                    currentGroupId = data.groupId;
                    loadGroupData();
                }
            });
        }

        function loadGroupData() {
            if (!database) return;

            console.log("üîç Loading group data for student:", studentId);

            // First check if student has a group
            database.ref('students/' + studentId + '/groupId').once('value', (snapshot) => {
                const groupId = snapshot.val();
                currentGroupId = groupId;

                console.log("üë• Student's groupId:", groupId);

                if (!groupId) {
                    // No group assigned yet - use individual mode
                    console.log("‚ÑπÔ∏è No group assigned - using individual mode");
                    document.getElementById('groupInfoBox').style.display = 'none';
                    progression.currentStage = 1;
                    progression.stageProgress = 0;
                    progression.stageTarget = 5;
                    updateStageUI();
                    return;
                }

                // Listen for group updates
                const groupRef = database.ref('groups/' + groupId);
                if (groupDataListener) {
                    groupRef.off('value', groupDataListener);
                }

                groupDataListener = groupRef.on('value', (groupSnapshot) => {
                    const groupData = groupSnapshot.val();
                    console.log("=".repeat(80));
                    console.log("üìäüìäüìä FIREBASE LISTENER FIRED FOR", studentId);
                    console.log("üìä Group data:", JSON.stringify(groupData, null, 2));

                    if (groupData) {
                        console.log("üîî Firebase listener triggered for", studentId);
                        console.log("üë• Group members:", groupData.members);
                        console.log("üìà Individual progress:", groupData.individualProgress);
                        console.log("üéØ Current group stage from Firebase:", groupData.currentStage);
                        console.log("üö´ stageDemoting flag:", groupData.stageDemoting);

                        // Check if current student is actually in this group
                        if (!groupData.members || !groupData.members.includes(studentId)) {
                            console.error("‚ùå ERROR: Student is NOT in this group!");
                            console.error("Student ID:", studentId);
                            console.error("Group members:", groupData.members);
                            showAlert('Error: You are assigned to a group you are not a member of. Please contact the teacher.', '‚ö†Ô∏è');
                            return;
                        }

                        // Get current stage from Firebase
                        const newStage = groupData.currentStage || 1;

                        // Check if stage has changed (for celebration/demotion modals)
                        // Only check if this is NOT the first load (lastKnownGroupStage is already set)
                        const isFirstLoad = (lastKnownGroupStage === null);
                        const previousStage = lastKnownGroupStage;
                        const stageAdvanced = (!isFirstLoad) && (newStage > previousStage);
                        const stageDemoted = (!isFirstLoad) && (newStage < previousStage);

                        console.log(`üéØ Stage check for ${studentId}:`);
                        console.log(`   isFirstLoad = ${isFirstLoad}`);
                        console.log(`   lastKnownGroupStage = ${lastKnownGroupStage}`);
                        console.log(`   previousStage = ${previousStage}`);
                        console.log(`   newStage = ${newStage}`);
                        console.log(`   stageAdvanced = ${stageAdvanced}`);
                        console.log(`   stageDemoted = ${stageDemoted}`);

                        // Update progression from group data
                        progression.currentStage = newStage;

                        // Update tracking variable AFTER checking for changes
                        lastKnownGroupStage = newStage;

                        // Display group info
                        displayGroupInfo(groupData);

                        // Calculate total group progress (sum of all individual progress)
                        const totalProgress = groupData.members.reduce((sum, m) =>
                            sum + (groupData.individualProgress?.[m] || 0), 0
                        );

                        // For progress bar: show how many correct answers the group has collectively
                        const myProgress = groupData.individualProgress?.[studentId] || 0;
                        const allComplete = groupData.members.every(m =>
                            (groupData.individualProgress?.[m] || 0) >= 5
                        );

                        // Update progress bar to show collective progress
                        progression.stageProgress = totalProgress;
                        progression.stageTarget = groupData.members.length * 5; // All members need 5 each

                        if (myProgress >= 5 && !allComplete) {
                            // Show waiting state at top
                            document.getElementById('waitingState').style.display = 'block';
                            // Show overlay on question area (more visible!)
                            document.getElementById('questionDisabledOverlay').style.display = 'flex';
                            // Disable submit button
                            document.getElementById('submitBtn').disabled = true;
                        } else {
                            document.getElementById('waitingState').style.display = 'none';
                            document.getElementById('questionDisabledOverlay').style.display = 'none';
                        }

                        // If all members complete, auto-advance stage
                        if (allComplete && !groupData.stageCompleting && !groupData.stageAdvanced) {
                            console.log("üéâ All members complete! Auto-advancing stage...");

                            // Auto-advance to next stage
                            if (newStage < 7) {
                                database.ref(`groups/${currentGroupId}`).transaction(gData => {
                                    if (gData && !gData.stageAdvanced) {
                                        gData.currentStage = (gData.currentStage || 1) + 1;
                                        gData.stageAdvanced = true;
                                        // Reset all individual progress
                                        if (gData.members) {
                                            gData.members.forEach(memberId => {
                                                gData.individualProgress[memberId] = 0;
                                            });
                                        }
                                    }
                                    return gData;
                                }).then(() => {
                                    console.log("‚úÖ Stage advanced successfully");
                                    // Remove the stageAdvanced flag after a delay
                                    setTimeout(() => {
                                        database.ref(`groups/${currentGroupId}/stageAdvanced`).set(false);
                                    }, 3000);
                                });
                            }
                        }

                        // Show celebration modal if stage just advanced (detected by listener)
                        if (stageAdvanced) {
                            console.log(`üéäüéäüéä ADVANCEMENT DETECTED by ${studentId}!`);
                            console.log(`üéä Stage advanced from ${previousStage} to ${newStage}!`);
                            setTimeout(() => {
                                showCelebration(false);
                                // Re-enable submit button and hide waiting state/overlay
                                document.getElementById('submitBtn').disabled = false;
                                document.getElementById('waitingState').style.display = 'none';
                                document.getElementById('questionDisabledOverlay').style.display = 'none';
                            }, 500);
                        }

                        // Show demotion modal if stage was demoted (detected by listener)
                        if (stageDemoted) {
                            console.log(`üò∞üò∞üò∞ DEMOTION DETECTED by ${studentId}!`);
                            console.log(`üò∞ Stage demoted from ${previousStage} to ${newStage}!`);
                            console.log(`üò∞ About to show demotion modal for student ${studentId}...`);
                            setTimeout(() => {
                                console.log(`üò∞ NOW CALLING showCelebration(true) for ${studentId}`);
                                showCelebration(true); // true = isDemotion
                                // Re-enable submit button and hide waiting state/overlay
                                document.getElementById('submitBtn').disabled = false;
                                document.getElementById('waitingState').style.display = 'none';
                                document.getElementById('questionDisabledOverlay').style.display = 'none';
                            }, 500);
                        } else {
                            console.log(`‚ÑπÔ∏è No stage change detected (stageDemoted=${stageDemoted}, stageAdvanced=${stageAdvanced})`);
                        }

                        updateStageUI();
                    }
                });
            });
        }

        function displayGroupInfo(groupData) {
            if (!groupData) return;

            document.getElementById('groupInfoBox').style.display = 'block';
            const membersList = document.getElementById('groupMembersList');

            // Get student names
            const promises = groupData.members.map(memberId =>
                database.ref('students/' + memberId + '/name').once('value')
            );

            Promise.all(promises).then(snapshots => {
                let html = '';
                groupData.members.forEach((memberId, index) => {
                    const memberName = snapshots[index].val() || 'Unknown';
                    const memberProgress = groupData.individualProgress?.[memberId] || 0;
                    const isMe = memberId === studentId;

                    html += `
                        <div class="group-member-item">
                            <span class="member-name">
                                ${isMe ? 'üë§ ' : ''}${memberName}${isMe ? ' (You)' : ''}
                            </span>
                            <span class="member-progress">${memberProgress}/5 ‚úì</span>
                        </div>
                    `;
                });
                membersList.innerHTML = html;
            });
        }

        function listenForStudents() {
            if (!database) return;

            console.log("üëÄ Teacher dashboard listening for students...");
            const studentsRef = database.ref('students');
            studentsRef.on('value', (snapshot) => {
                const students = snapshot.val();
                console.log("üìä Students data received:", students);
                updateDashboard(students);
            });
        }

        // ==================== GROUP MANAGEMENT FUNCTIONS ====================
        function autoAssignGroups() {
            console.log("üîç autoAssignGroups function called!");

            if (!database) {
                console.error("‚ùå Database not initialized!");
                showAlert('Firebase is not configured.', '‚ö†Ô∏è');
                return;
            }

            console.log("üë• Auto-assigning groups...");
            const studentsRef = database.ref('students');
            studentsRef.once('value', (snapshot) => {
                console.log("üìä Firebase query completed");
                const students = snapshot.val();
                console.log("üë• Students data:", students);

                if (!students || Object.keys(students).length === 0) {
                    console.warn("‚ö†Ô∏è No students found!");
                    showAlert('No students logged in yet! Students need to log in before creating groups.', 'üìö');
                    return;
                }

                const studentList = Object.keys(students).map(id => ({
                    id: id,
                    name: students[id].name
                }));
                console.log("üìã Student list:", studentList);

                // Shuffle students randomly
                for (let i = studentList.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [studentList[i], studentList[j]] = [studentList[j], studentList[i]];
                }

                // Create groups
                const groups = [];
                let groupNumber = 1;
                for (let i = 0; i < studentList.length; i += 2) {
                    const groupMembers = [];
                    groupMembers.push(studentList[i].id);

                    // If this is the last student and we have an odd number, add to previous group
                    if (i === studentList.length - 1 && groupNumber > 1) {
                        // Add to previous group
                        groups[groups.length - 1].members.push(studentList[i].id);
                        continue;
                    }

                    // Otherwise, create pair or final group of 3
                    if (i + 1 < studentList.length) {
                        groupMembers.push(studentList[i + 1].id);
                    }

                    groups.push({
                        id: `group_${groupNumber}`,
                        number: groupNumber,
                        members: groupMembers,
                        currentStage: 1,
                        individualProgress: {}
                    });
                    groupNumber++;
                }

                // Save groups to Firebase
                const groupsRef = database.ref('groups');

                console.log("üîÑ Clearing existing groups...");
                groupsRef.set(null).then(() => {
                    console.log("‚úÖ Existing groups cleared");

                    // Prepare groups with initialized individual progress
                    const groupsToSave = {};
                    groups.forEach(group => {
                        // Initialize individual progress within the group object
                        group.members.forEach(memberId => {
                            group.individualProgress[memberId] = 0;
                        });
                        groupsToSave[group.id] = group;
                    });

                    console.log("üì¶ Groups to save:", groupsToSave);

                    // Update students with their group ID
                    const studentUpdates = {};
                    groups.forEach(group => {
                        group.members.forEach(memberId => {
                            studentUpdates['students/' + memberId + '/groupId'] = group.id;
                        });
                    });

                    console.log("üë• Student updates:", studentUpdates);

                    // Save groups and update students
                    groupsRef.set(groupsToSave).then(() => {
                        console.log("‚úÖ Groups saved to Firebase");
                        database.ref().update(studentUpdates).then(() => {
                            console.log("‚úÖ Students updated with group IDs");
                            showAlert(`Successfully created ${groups.length} groups!`, '‚úÖ');
                        }).catch(error => {
                            console.error("‚ùå Error updating students:", error);
                            showAlert('Error assigning groups to students: ' + error.message, '‚ùå');
                        });
                    }).catch(error => {
                        console.error("‚ùå Error saving groups:", error);
                        showAlert('Error saving groups: ' + error.message, '‚ùå');
                    });
                }).catch(error => {
                    console.error("‚ùå Error clearing groups:", error);
                    showAlert('Error clearing existing groups: ' + error.message, '‚ùå');
                });
            });
        }

        function listenForGroups() {
            if (!database) return;

            console.log("üëÄ Teacher dashboard listening for groups...");
            const groupsRef = database.ref('groups');
            groupsRef.on('value', (snapshot) => {
                const groups = snapshot.val();
                console.log("üìä Groups data received:", groups);
                updateGroupsDisplay(groups);
                updateGroupChart(groups); // Update chart whenever groups change
            });
        }

        function toggleGroupChart() {
            const chart = document.getElementById('groupProgressChart');
            const btn = document.getElementById('chartToggleBtn');

            if (chart.style.display === 'none') {
                chart.style.display = 'block';
                btn.textContent = 'üìä Hide Progress Chart';
            } else {
                chart.style.display = 'none';
                btn.textContent = 'üìä Show Progress Chart';
            }
        }

        function updateGroupChart(groups) {
            const chartBars = document.getElementById('chartBars');

            if (!groups || Object.keys(groups).length === 0) {
                chartBars.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">No groups to display</p>';
                return;
            }

            // Get student names first
            database.ref('students').once('value', (snapshot) => {
                const students = snapshot.val() || {};

                let html = '';
                Object.keys(groups).forEach(groupId => {
                    const group = groups[groupId];
                    const stageInfo = stages[group.currentStage] || stages[1];
                    const percentage = (group.currentStage / 7) * 100; // 7 stages total

                    // Get member names
                    const memberNames = group.members.map(memberId =>
                        students[memberId]?.name || memberId
                    ).join(' & ');

                    html += `
                        <div class="chart-bar-row">
                            <div class="chart-label" style="min-width: 150px;">
                                ${stageInfo.icon} ${memberNames}
                            </div>
                            <div class="chart-bar-container">
                                <div class="chart-bar-fill" style="width: ${percentage}%">
                                    Stage ${group.currentStage}
                                </div>
                            </div>
                            <div class="chart-stage-indicator">
                                <span class="chart-stage-icon">${stageInfo.icon}</span>
                                ${stageInfo.name}
                            </div>
                        </div>
                    `;
                });

                chartBars.innerHTML = html;
            });
        }

        function updateGroupsDisplay(groups) {
            const container = document.getElementById('groupsContainer');
            const noGroupsMessage = document.getElementById('noGroupsMessage');

            if (!groups || Object.keys(groups).length === 0) {
                container.innerHTML = '';
                noGroupsMessage.style.display = 'block';
                return;
            }

            noGroupsMessage.style.display = 'none';

            // Get all students for name lookup
            database.ref('students').once('value', (snapshot) => {
                const students = snapshot.val() || {};

                let html = '';
                Object.keys(groups).forEach(groupId => {
                    const group = groups[groupId];
                    const stageInfo = stages[group.currentStage] || stages[1];

                    html += `
                        <div class="group-card">
                            <div class="group-header">
                                <span>${stageInfo.icon}</span>
                                <span>Group ${group.number}</span>
                            </div>
                            <div style="text-align: center; padding: 0.5rem 0; font-size: 0.875rem; color: var(--accent-purple); font-weight: 600;">
                                Stage ${group.currentStage}: ${stageInfo.name}
                            </div>
                            <ul class="group-members">
                    `;

                    group.members.forEach(memberId => {
                        const memberName = students[memberId]?.name || 'Unknown';
                        const memberProgress = group.individualProgress?.[memberId] || 0;
                        html += `
                            <li class="group-member">
                                ${memberName}: <strong>${memberProgress}/5</strong> correct
                            </li>
                        `;
                    });

                    const allComplete = group.members.every(m => (group.individualProgress?.[m] || 0) >= 5);
                    html += `
                            </ul>
                            <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid var(--border); text-align: center;">
                                <small style="color: var(--text-secondary);">
                                    ${allComplete ? '‚úÖ Ready to advance!' : '‚è≥ Working together...'}
                                </small>
                            </div>
                        </div>
                    `;
                });

                container.innerHTML = html;
            });
        }

        // ==================== CLEAR STUDENTS FUNCTION ====================
        function confirmClearAllStudents() {
            showConfirm(
                'Are you sure you want to remove all students from the database? This action cannot be undone!',
                clearAllStudents,
                'üóëÔ∏è'
            );
        }

        function clearAllStudents() {
            if (!database) {
                showAlert('Firebase is not configured.', '‚ö†Ô∏è');
                return;
            }

            console.log("üóëÔ∏è Clearing all students and groups...");
            const studentsRef = database.ref('students');
            const groupsRef = database.ref('groups');

            // Clear both students and groups
            Promise.all([studentsRef.remove(), groupsRef.remove()])
                .then(() => {
                    console.log("‚úÖ All students and groups cleared successfully!");
                    showAlert('All students and groups have been removed from the database.', '‚úÖ');
                })
                .catch((error) => {
                    console.error("‚ùå Error clearing data:", error);
                    showAlert('Error clearing data: ' + error.message, '‚ùå');
                });
        }

        // ==================== TEACHER DASHBOARD ====================
        function updateDashboard(students) {
            const container = document.getElementById('studentsContainer');
            const emptyState = document.getElementById('emptyState');

            if (!students || Object.keys(students).length === 0) {
                container.innerHTML = '';
                emptyState.classList.remove('hidden');
                document.getElementById('dashTotalStudents').textContent = '0';
                document.getElementById('dashAvgStage').textContent = '0';
                document.getElementById('dashAvgAccuracy').textContent = '0%';
                document.getElementById('dashTotalQuestions').textContent = '0';
                return;
            }

            emptyState.classList.add('hidden');

            let html = '';
            let totalStage = 0;
            let totalQuestions = 0;
            let totalCorrect = 0;
            let activeCount = 0;

            const now = Date.now();
            const ACTIVE_THRESHOLD = 60000; // 1 minute

            Object.keys(students).forEach(key => {
                const student = students[key];
                const isActive = student.isActive && (now - (student.lastActive || 0)) < ACTIVE_THRESHOLD;
                const accuracy = student.totalQuestions > 0 ? Math.round((student.correctAnswers / student.totalQuestions) * 100) : 0;
                const progressPercent = Math.max(0, (student.stageProgress / 5) * 100);

                totalStage += student.currentStage || 1;
                totalQuestions += student.totalQuestions || 0;
                totalCorrect += student.correctAnswers || 0;

                const stageIcon = stages[student.currentStage]?.icon || 'üå±';
                const stageName = stages[student.currentStage]?.name || 'Stage 1';

                html += `
                    <div class="student-card">
                        <div class="student-name">
                            <span class="status-indicator ${isActive ? 'status-active' : 'status-inactive'}"></span>
                            ${student.name}
                        </div>
                        <div class="student-stage">${stageIcon} ${stageName}</div>
                        <div class="student-stats">
                            <div class="student-stat">
                                <span class="student-stat-value">${student.totalQuestions || 0}</span>
                                <span class="student-stat-label">Questions</span>
                            </div>
                            <div class="student-stat">
                                <span class="student-stat-value">${accuracy}%</span>
                                <span class="student-stat-label">Accuracy</span>
                            </div>
                        </div>
                        <div class="student-progress">
                            <div class="student-progress-label">
                                <span>Stage Progress</span>
                                <span>${student.stageProgress || 0}/5</span>
                            </div>
                            <div class="student-progress-bar">
                                <div class="student-progress-fill" style="width: ${progressPercent}%"></div>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;

            // Update dashboard stats
            const studentCount = Object.keys(students).length;
            const avgStage = studentCount > 0 ? (totalStage / studentCount).toFixed(1) : 0;
            const avgAccuracy = totalQuestions > 0 ? Math.round((totalCorrect / totalQuestions) * 100) : 0;

            document.getElementById('dashTotalStudents').textContent = studentCount;
            document.getElementById('dashAvgStage').textContent = avgStage;
            document.getElementById('dashAvgAccuracy').textContent = avgAccuracy + '%';
            document.getElementById('dashTotalQuestions').textContent = totalQuestions;
        }

        // ==================== STUDENT GAME FUNCTIONS ====================
        function updateStageUI() {
            const stage = stages[progression.currentStage];
            document.getElementById('stageName').textContent = stage.name;
            document.getElementById('stageIcon').textContent = stage.icon;
            document.getElementById('stageBadge').textContent = `Level ${progression.currentStage}/7`;
            document.getElementById('stageDescription').textContent = stage.description;

            // Update hints
            document.getElementById('hintsTitle').textContent = `üí° Quick Tips - ${stage.name}`;
            const hintsList = document.getElementById('hintsList');
            hintsList.innerHTML = stage.hints.map(hint => `<li>${hint}</li>`).join('');

            // Show/hide questions based on stage
            document.getElementById('questionA').classList.remove('hidden');
            document.getElementById('questionC').classList.toggle('hidden', !stage.tests.includes('c'));
            document.getElementById('questionDelta').classList.toggle('hidden', !stage.tests.includes('delta'));
            document.getElementById('questionAxis').classList.toggle('hidden', !stage.tests.includes('axis'));
            document.getElementById('questionB').classList.toggle('hidden', !stage.tests.includes('b'));
            document.getElementById('questionVertexX').classList.toggle('hidden', !stage.tests.includes('vertex-x'));
            document.getElementById('questionVertexY').classList.toggle('hidden', !stage.tests.includes('vertex-y'));

            // Update badge indicators
            for (let i = 1; i <= 5; i++) {
                const badge = document.getElementById(`badge${i}`);
                badge.classList.remove('completed', 'current');
                if (i < progression.currentStage) {
                    badge.classList.add('completed');
                } else if (i === progression.currentStage) {
                    badge.classList.add('current');
                }
            }

            updateProgressBar();
        }

        function updateProgressBar() {
            const percent = Math.max(0, (progression.stageProgress / progression.stageTarget) * 100);
            document.getElementById('progressFill').style.width = percent + '%';

            // Show different text if in group mode
            if (currentGroupId && progression.stageTarget > 5) {
                document.getElementById('progressText').textContent = `${progression.stageProgress}/${progression.stageTarget} team correct`;
            } else {
                document.getElementById('progressText').textContent = `${progression.stageProgress}/${progression.stageTarget} correct`;
            }

            if (percent > 10) {
                document.getElementById('progressPercent').textContent = Math.round(percent) + '%';
            } else {
                document.getElementById('progressPercent').textContent = '';
            }
        }

        function showCelebration(isDemotion = false) {
            const modal = document.getElementById('celebrationModal');
            const content = document.querySelector('.celebration-content');
            const btn = document.getElementById('celebrationBtn');

            content.classList.remove('demotion');

            if (isDemotion) {
                const prevStage = stages[progression.currentStage - 1];
                content.classList.add('demotion');
                document.getElementById('celebrationIcon').textContent = 'üò∞';
                document.getElementById('celebrationTitle').textContent = 'Stage Demotion!';
                document.getElementById('celebrationMessage').textContent = `Don't worry! You're moving back to ${prevStage.name}. Review the concepts and you'll master it!`;
                btn.textContent = 'Continue';
                btn.onclick = demoteStage;
            } else {
                const stage = stages[progression.currentStage];
                const icons = ['üéâ', 'üéä', '‚ú®', 'üåü', 'üí´', 'üéà'];
                const messages = [
                    "Amazing work! Ready for the next challenge?",
                    "You're getting better and better!",
                    "Fantastic! Keep up the great work!",
                    "Excellent progress! You're a star!",
                    "Brilliant! Let's level up!"
                ];

                if (progression.currentStage === 5) {
                    document.getElementById('celebrationIcon').textContent = 'ÔøΩÔøΩÔøΩÔøΩ';
                    document.getElementById('celebrationTitle').textContent = 'You\'re a Master!';
                    document.getElementById('celebrationMessage').textContent = 'Congratulations! You\'ve mastered all stages of parabola analysis!';
                    btn.textContent = 'Continue Learning';
                } else {
                    document.getElementById('celebrationIcon').textContent = icons[Math.floor(Math.random() * icons.length)];
                    document.getElementById('celebrationTitle').textContent = `${stage.name} Complete!`;
                    document.getElementById('celebrationMessage').textContent = messages[Math.floor(Math.random() * messages.length)];
                    btn.textContent = 'Continue to Next Stage';
                }
                btn.onclick = advanceStage;
                createConfetti();
            }

            modal.classList.add('show');
        }

        function createConfetti() {
            const content = document.querySelector('.celebration-content');
            const colors = ['#3b82f6', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899'];

            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDelay = Math.random() * 3 + 's';
                content.appendChild(confetti);

                setTimeout(() => confetti.remove(), 3000);
            }
        }

        function advanceStage() {
            document.getElementById('celebrationModal').classList.remove('show');

            if (currentGroupId && database) {
                // Group mode - stage already auto-advanced, just close modal and start new question
                // Re-enable submit button
                document.getElementById('submitBtn').disabled = false;
                document.getElementById('waitingState').style.display = 'none';
                generateNewQuestion();
            } else {
                // No group - use old system
                if (progression.currentStage < 7) {
                    progression.currentStage++;
                    progression.stageProgress = 0;
                    progression.completedStages.push(progression.currentStage - 1);
                    updateStageUI();
                    saveStudentProgress();
                    generateNewQuestion();
                } else {
                    updateStageUI();
                    saveStudentProgress();
                    generateNewQuestion();
                }
            }
        }

        function demoteGroup() {
            if (!currentGroupId || !database) {
                console.warn("‚ö†Ô∏è demoteGroup called but no group or database");
                return Promise.resolve(); // Return resolved promise if no group
            }

            console.log("üìâüìâüìâ demoteGroup() CALLED for group:", currentGroupId);
            console.log("üìâ Current studentId:", studentId);

            // Demote the group stage and reset all progress
            return database.ref(`groups/${currentGroupId}`).transaction(gData => {
                console.log("üîÑ Transaction running, gData:", gData);

                if (!gData) {
                    console.error("‚ùå No group data in transaction!");
                    return gData;
                }

                console.log("üìä Current group stage:", gData.currentStage);
                console.log("üö´ stageDemoting flag:", gData.stageDemoting);

                if (gData.stageDemoting) {
                    console.warn("‚ö†Ô∏è Demotion already in progress, skipping");
                    return gData; // Abort - already demoting
                }

                if ((gData.currentStage || 1) <= 1) {
                    console.warn("‚ö†Ô∏è Already at stage 1, cannot demote further");
                    return gData;
                }

                // Perform demotion
                const oldStage = gData.currentStage;
                gData.currentStage = (gData.currentStage || 1) - 1;
                gData.stageDemoting = true;

                // Reset all individual progress to 0
                if (gData.members) {
                    gData.members.forEach(memberId => {
                        gData.individualProgress[memberId] = 0;
                    });
                }

                console.log(`‚úÖ‚úÖ‚úÖ DEMOTING GROUP from stage ${oldStage} to ${gData.currentStage}`);
                console.log(`‚úÖ Resetting all member progress to 0`);

                return gData;
            }).then((result) => {
                if (result.committed) {
                    console.log("‚úÖ Group demotion transaction COMMITTED successfully!");
                } else {
                    console.error("‚ùå Group demotion transaction FAILED!");
                }

                // Remove the stageDemoting flag after a delay
                setTimeout(() => {
                    console.log("üîì Clearing stageDemoting flag...");
                    database.ref(`groups/${currentGroupId}/stageDemoting`).set(false);
                }, 3000);
            }).catch(error => {
                console.error("‚ùå Error in demoteGroup transaction:", error);
            });
        }

        function demoteStage() {
            document.getElementById('celebrationModal').classList.remove('show');

            if (currentGroupId && database) {
                // Group mode - demotion already happened automatically, just close modal
                generateNewQuestion();
            } else {
                // No group - use old system
                if (progression.currentStage > 1) {
                    progression.currentStage--;
                    progression.stageProgress = 0;
                    const index = progression.completedStages.indexOf(progression.currentStage);
                    if (index > -1) {
                        progression.completedStages.splice(index, 1);
                    }
                    updateStageUI();
                    saveStudentProgress();
                    generateNewQuestion();
                } else {
                    progression.stageProgress = 0;
                    updateStageUI();
                    saveStudentProgress();
                    generateNewQuestion();
                }
            }
        }

        function generateRandomCoefficient(min, max, allowZero = false) {
            let val;
            do {
                val = Math.random() * (max - min) + min;
                if (allowZero && Math.abs(val) < 0.5) {
                    val = 0;
                }
            } while (Math.abs(val) < 0.1 && val !== 0);
            return val;
        }

        function generateNewQuestion() {
            currentQuestion.a = generateRandomCoefficient(-2, 2, false);
            if (currentQuestion.a > -0.3 && currentQuestion.a < 0.3) {
                currentQuestion.a = currentQuestion.a > 0 ? 0.5 : -0.5;
            }

            currentQuestion.b = generateRandomCoefficient(-4, 4, true);
            currentQuestion.c = generateRandomCoefficient(-3, 3, true);

            document.getElementById('currentStage').textContent = `Stage ${progression.currentStage}`;

            const stage = stages[progression.currentStage];
            userAnswers = { a: null, b: null, c: null, delta: null, axis: null };

            document.querySelectorAll('.option-btn').forEach(btn => {
                btn.classList.remove('selected', 'correct', 'incorrect');
                btn.disabled = false;
            });

            document.getElementById('submitBtn').style.display = 'block';
            document.getElementById('submitBtn').disabled = false;
            document.getElementById('nextBtn').style.display = 'none';
            document.getElementById('feedback').classList.remove('show');

            drawParabola();
        }

        function drawParabola() {
            const width = canvas.width;
            const height = canvas.height;
            const { a, b, c } = currentQuestion;

            ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--bg-dark').trim();
            ctx.fillRect(0, 0, width, height);

            const scale = 40;
            const originX = width / 2;
            const originY = height / 2;

            // Draw grid
            ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--border').trim();
            ctx.lineWidth = 1;

            for (let i = -10; i <= 10; i++) {
                ctx.beginPath();
                ctx.moveTo(originX + i * scale, 0);
                ctx.lineTo(originX + i * scale, height);
                ctx.stroke();

                ctx.beginPath();
                ctx.moveTo(0, originY + i * scale);
                ctx.lineTo(width, originY + i * scale);
                ctx.stroke();
            }

            // Draw axes
            ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--text-secondary').trim();
            ctx.lineWidth = 2;

            ctx.beginPath();
            ctx.moveTo(0, originY);
            ctx.lineTo(width, originY);
            ctx.stroke();

            ctx.beginPath();
            ctx.moveTo(originX, 0);
            ctx.lineTo(originX, height);
            ctx.stroke();

            // Draw parabola
            ctx.strokeStyle = '#3b82f6';
            ctx.lineWidth = 3;
            ctx.beginPath();

            let firstPoint = true;
            for (let px = 0; px < width; px++) {
                const x = (px - originX) / scale;
                const y = a * x * x + b * x + c;
                const py = originY - y * scale;

                if (py >= 0 && py <= height) {
                    if (firstPoint) {
                        ctx.moveTo(px, py);
                        firstPoint = false;
                    } else {
                        ctx.lineTo(px, py);
                    }
                }
            }
            ctx.stroke();

            // Draw vertex
            const vertexX = -b / (2 * a);
            const vertexY = a * vertexX * vertexX + b * vertexX + c;
            const vertexPx = originX + vertexX * scale;
            const vertexPy = originY - vertexY * scale;

            if (vertexPx >= 0 && vertexPx <= width && vertexPy >= 0 && vertexPy <= height) {
                ctx.fillStyle = '#8b5cf6';
                ctx.beginPath();
                ctx.arc(vertexPx, vertexPy, 6, 0, 2 * Math.PI);
                ctx.fill();
            }

            // Draw y-intercept
            const interceptPy = originY - c * scale;
            if (interceptPy >= 0 && interceptPy <= height) {
                ctx.fillStyle = '#f59e0b';
                ctx.beginPath();
                ctx.arc(originX, interceptPy, 6, 0, 2 * Math.PI);
                ctx.fill();
            }

            // Draw x-intercepts (roots)
            const discriminant = b * b - 4 * a * c;
            if (discriminant >= -0.01) {
                const sqrtDisc = Math.sqrt(Math.max(0, discriminant));
                const root1 = (-b + sqrtDisc) / (2 * a);
                const root2 = (-b - sqrtDisc) / (2 * a);

                const root1Px = originX + root1 * scale;
                if (root1Px >= 0 && root1Px <= width) {
                    ctx.fillStyle = '#ef4444';
                    ctx.beginPath();
                    ctx.arc(root1Px, originY, 7, 0, 2 * Math.PI);
                    ctx.fill();
                    ctx.strokeStyle = '#ffffff';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                }

                if (Math.abs(discriminant) > 0.01) {
                    const root2Px = originX + root2 * scale;
                    if (root2Px >= 0 && root2Px <= width) {
                        ctx.fillStyle = '#ef4444';
                        ctx.beginPath();
                        ctx.arc(root2Px, originY, 7, 0, 2 * Math.PI);
                        ctx.fill();
                        ctx.strokeStyle = '#ffffff';
                        ctx.lineWidth = 2;
                        ctx.stroke();
                    }
                }
            }

            // Draw axis labels
            ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--text-secondary').trim();
            ctx.font = '14px Fira Code';
            ctx.fillText('x', width - 20, originY - 10);
            ctx.fillText('y', originX + 10, 20);
        }

        // Handle option selection
        document.querySelectorAll('.option-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const coeff = this.dataset.coeff;
                const value = this.dataset.value;

                document.querySelectorAll(`[data-coeff="${coeff}"]`).forEach(b => {
                    b.classList.remove('selected');
                });

                this.classList.add('selected');
                userAnswers[coeff] = value;

                const stage = stages[progression.currentStage];
                const allAnswered = stage.tests.every(test => userAnswers[test] !== null);
                document.getElementById('submitBtn').disabled = !allAnswered;
            });
        });

        function getSign(num) {
            if (Math.abs(num) < 0.01) return '0';
            return num > 0 ? '+' : '-';
        }

        function checkAnswer() {
            const stage = stages[progression.currentStage];
            const correctA = getSign(currentQuestion.a);
            const correctB = getSign(currentQuestion.b);
            const correctC = getSign(currentQuestion.c);
            const discriminant = currentQuestion.b * currentQuestion.b - 4 * currentQuestion.a * currentQuestion.c;
            const correctDelta = getSign(discriminant);
            const axisOfSymmetry = -currentQuestion.b / (2 * currentQuestion.a);
            const correctAxis = getSign(axisOfSymmetry);

            // Calculate vertex coordinates
            const vertexX = axisOfSymmetry;
            const correctVertexX = getSign(vertexX);
            const vertexY = currentQuestion.a * vertexX * vertexX + currentQuestion.b * vertexX + currentQuestion.c;
            const correctVertexY = getSign(vertexY);

            let isCorrect = true;
            stage.tests.forEach(test => {
                let correct;
                if (test === 'a') correct = correctA;
                else if (test === 'b') correct = correctB;
                else if (test === 'c') correct = correctC;
                else if (test === 'delta') correct = correctDelta;
                else if (test === 'axis') correct = correctAxis;
                else if (test === 'vertex-x') correct = correctVertexX;
                else if (test === 'vertex-y') correct = correctVertexY;

                if (userAnswers[test] !== correct) {
                    isCorrect = false;
                }
            });

            stats.total++;
            let checkForDemotion = false;

            if (isCorrect) {
                stats.correct++;

                // Update individual progress in group if in a group
                if (currentGroupId && database) {
                    database.ref(`groups/${currentGroupId}/individualProgress/${studentId}`).transaction(currentProgress => {
                        return Math.min(5, (currentProgress || 0) + 1);
                    });
                } else {
                    // No group - use old system
                    progression.stageProgress++;
                }
            } else {
                // Wrong answer - deduct individual progress
                if (currentGroupId && database) {
                    console.log("‚ùå Wrong answer in group mode");
                    console.log("üë• Current groupId:", currentGroupId);
                    console.log("üë§ StudentId:", studentId);

                    database.ref(`groups/${currentGroupId}/individualProgress/${studentId}`).transaction(currentProgress => {
                        const newProgress = (currentProgress || 0) - 1;
                        console.log(`üìä Progress transaction: ${currentProgress} ‚Üí ${newProgress}`);
                        return newProgress; // Allow negative to trigger demotion
                    }).then((result) => {
                        const finalProgress = result.snapshot.val();
                        console.log("üìâ Student progress after wrong answer:", finalProgress);
                        console.log("üéØ Current stage:", progression.currentStage);
                        console.log("üîç Checking demotion condition:");
                        console.log("   - finalProgress < 0?", finalProgress < 0);
                        console.log("   - progression.currentStage > 1?", progression.currentStage > 1);

                        // If progress went negative and stage > 1, demote entire group
                        if (finalProgress < 0 && progression.currentStage > 1) {
                            console.log("‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è DEMOTION CONDITION MET!");
                            console.log("‚ö†Ô∏è Triggering group demotion from stage", progression.currentStage);
                            console.log("‚ö†Ô∏è Student", studentId, "triggered demotion!");

                            // Demote the group - the Firebase listener will show modal for ALL teammates
                            demoteGroup().then(() => {
                                console.log("‚úÖ demoteGroup() promise resolved!");
                            }).catch(error => {
                                console.error("‚ùå demoteGroup() promise rejected:", error);
                            });
                        } else if (finalProgress < 0 && progression.currentStage === 1) {
                            // At Stage 1, can't demote further - set floor at 0
                            console.log("üõë At Stage 1, setting progress floor at 0");
                            database.ref(`groups/${currentGroupId}/individualProgress/${studentId}`).set(0);
                        } else {
                            console.log("‚ÑπÔ∏è Demotion condition NOT met");
                        }
                    }).catch(error => {
                        console.error("‚ùå Error in progress transaction:", error);
                    });
                } else {
                    progression.stageProgress--;
                    if (progression.stageProgress < 0 && progression.currentStage > 1) {
                        checkForDemotion = true;
                    } else if (progression.stageProgress < 0) {
                        progression.stageProgress = 0;
                    }
                }
            }

            updateStats();
            updateProgressBar();
            saveStudentProgress();

            const feedback = document.getElementById('feedback');
            feedback.classList.add('show');

            stage.tests.forEach(coeff => {
                const correct = coeff === 'a' ? correctA :
                               coeff === 'b' ? correctB :
                               coeff === 'c' ? correctC :
                               coeff === 'delta' ? correctDelta :
                               coeff === 'axis' ? correctAxis :
                               coeff === 'vertex-x' ? correctVertexX :
                               coeff === 'vertex-y' ? correctVertexY : correctAxis;
                document.querySelectorAll(`[data-coeff="${coeff}"]`).forEach(btn => {
                    btn.disabled = true;
                    if (btn.dataset.value === correct) {
                        btn.classList.add('correct');
                        btn.classList.remove('selected');
                    } else if (btn.classList.contains('selected')) {
                        btn.classList.add('incorrect');
                    }
                });
            });

            if (isCorrect) {
                feedback.className = 'feedback show success';
                const encouragements = [
                    "‚úÖ Perfect! Great job!",
                    "‚úÖ Excellent work!",
                    "‚úÖ You got it right!",
                    "‚úÖ Amazing! Keep it up!",
                    "‚úÖ Fantastic! You're a star!"
                ];
                const encouragement = encouragements[Math.floor(Math.random() * encouragements.length)];

                let details = `<strong>${encouragement}</strong><br>`;
                if (stage.tests.includes('a')) details += `a = ${currentQuestion.a.toFixed(2)} (${correctA}), `;
                if (stage.tests.includes('c')) details += `c = ${currentQuestion.c.toFixed(2)} (${correctC}), `;
                if (stage.tests.includes('delta')) details += `Œî = ${discriminant.toFixed(2)} (${correctDelta}), `;
                if (stage.tests.includes('axis')) details += `Axis = ${axisOfSymmetry.toFixed(2)} (${correctAxis}), `;
                if (stage.tests.includes('b')) details += `b = ${currentQuestion.b.toFixed(2)} (${correctB})`;

                feedback.innerHTML = details;

                if (progression.stageProgress >= progression.stageTarget && progression.currentStage < 7) {
                    setTimeout(() => showCelebration(false), 1000);
                } else if (progression.stageProgress >= progression.stageTarget && progression.currentStage === 7) {
                    setTimeout(() => showCelebration(false), 1000);
                }
            } else {
                feedback.className = 'feedback show error';
                let details = `<strong>‚ùå Not quite! Let's review:</strong><br>`;
                if (stage.tests.includes('a')) details += `a is ${correctA === '+' ? 'positive' : correctA === '-' ? 'negative' : 'zero'}, `;
                if (stage.tests.includes('c')) details += `c is ${correctC === '+' ? 'positive' : correctC === '-' ? 'negative' : 'zero'}, `;
                if (stage.tests.includes('delta')) details += `Œî is ${correctDelta === '+' ? 'positive' : correctDelta === '-' ? 'negative' : 'zero'}, `;
                if (stage.tests.includes('axis')) details += `Axis is ${correctAxis === '+' ? 'positive' : correctAxis === '-' ? 'negative' : 'zero'}, `;
                if (stage.tests.includes('b')) details += `b is ${correctB === '+' ? 'positive' : correctB === '-' ? 'negative' : 'zero'}`;

                details += '<br><small>Study the graph and try again!</small>';

                if (progression.stageProgress >= 0) {
                    details += `<br><small style="color: var(--accent-yellow);">‚ö†Ô∏è Progress: ${progression.stageProgress}/${progression.stageTarget} (-1 for wrong answer)</small>`;
                }

                feedback.innerHTML = details;

                if (checkForDemotion) {
                    setTimeout(() => showCelebration(true), 1500);
                }
            }

            document.getElementById('submitBtn').style.display = 'none';
            document.getElementById('nextBtn').style.display = 'block';
        }

        function updateStats() {
            document.getElementById('totalQuestions').textContent = stats.total;
            document.getElementById('correctAnswers').textContent = stats.correct;
            const accuracy = stats.total > 0 ? Math.round((stats.correct / stats.total) * 100) : 0;
            document.getElementById('accuracy').textContent = accuracy + '%';
        }

        // Toggle QR code visibility
        function toggleQRCode() {
            const container = document.getElementById('qrCodeContainer');
            const btn = document.getElementById('qrToggleBtn');

            if (container.style.display === 'none') {
                container.style.display = 'flex';
                btn.textContent = 'üì± Hide QR Code';
            } else {
                container.style.display = 'none';
                btn.textContent = 'üì± Show QR Code';
            }
        }

        // Generate QR code with current URL when page loads
        window.addEventListener('load', function() {
            const currentUrl = window.location.href;
            const qrcodeElement = document.getElementById('qrcode');

            // Clear any existing QR code
            qrcodeElement.innerHTML = '';

            // Generate new QR code
             
            new QRCode(qrcodeElement, {
                text: currentUrl,
                width: 180,
                height: 180,
                colorDark: "#0f172a",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });

            console.log("üì± QR code generated for URL:", currentUrl);
        });
    </script>
</body>
</html>
