<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>學生照片訂購系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Firebase 9 SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, addDoc, query, where, orderBy } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getStorage, ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';

        // Firebase 配置 - 請替換為您的配置


		const firebaseConfig = {
		  apiKey: "AIzaSyBQM-iulKQP_-TpX0uP0Q75An0ugs9q-Y0",
		  authDomain: "ndcphoto-66e17.firebaseapp.com",
		  projectId: "ndcphoto-66e17",
		  storageBucket: "ndcphoto-66e17.firebasestorage.app",
		  messagingSenderId: "747712936503",
		  appId: "1:747712936503:web:05ff8734fb1c7e930e9db2",
		  measurementId: "G-5V3S580BXN"
		};



        // 初始化 Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const provider = new GoogleAuthProvider();

        // 將 Firebase 服務掛載到 window 對象以供全局使用
        window.firebaseAuth = auth;
        window.firebaseDB = db;
        window.firebaseStorage = storage;
        window.GoogleAuthProvider = GoogleAuthProvider;
        window.signInWithPopup = signInWithPopup;
        window.onAuthStateChanged = onAuthStateChanged;
        window.signOut = signOut;
        window.collection = collection;
        window.doc = doc;
        window.setDoc = setDoc;
        window.getDoc = getDoc;
        window.getDocs = getDocs;
        window.addDoc = addDoc;
        window.query = query;
        window.where = where;
        window.orderBy = orderBy;
        window.ref = ref;
        window.uploadBytes = uploadBytes;
        window.getDownloadURL = getDownloadURL;
        window.provider = provider;
    </script>

    <style>
        .signature-pad {
            border: 2px dashed #d1d5db;
            cursor: crosshair;
        }
        .signature-pad:hover {
            border-color: #6b7280;
        }
        .loading {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #5D5CDE;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100">
    <!-- 載入畫面 -->
    <div id="loadingScreen" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 to-indigo-100 dark:from-gray-800 dark:to-gray-900">
        <div class="text-center">
            <div class="loading mx-auto mb-4"></div>
            <p class="text-gray-600 dark:text-gray-400">載入中...</p>
        </div>
    </div>

    <!-- 登入頁面 -->
    <div id="loginPage" class="hidden min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 to-indigo-100 dark:from-gray-800 dark:to-gray-900">
        <div class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-lg w-full max-w-md">
            <div class="text-center mb-6">
                <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">學生照片訂購系統</h1>
                <p class="text-gray-600 dark:text-gray-400">請使用 Google 帳號登入</p>
            </div>
            
            <button onclick="signInWithGoogle()" class="w-full bg-red-500 hover:bg-red-600 text-white font-semibold py-3 px-4 rounded-lg flex items-center justify-center space-x-2 transition-colors">
                <i class="fab fa-google"></i>
                <span>使用 Google 登入</span>
            </button>
        </div>
    </div>

    <!-- 學生頁面 -->
    <div id="studentPage" class="hidden min-h-screen bg-gray-50 dark:bg-gray-900">
        <!-- 導航欄 -->
        <nav class="bg-white dark:bg-gray-800 shadow-sm">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16">
                    <div class="flex items-center">
                        <h1 class="text-xl font-semibold">學生照片訂購</h1>
                    </div>
                    <div class="flex items-center space-x-4">
                        <img id="userAvatar" src="" alt="頭像" class="w-8 h-8 rounded-full">
                        <span id="studentName" class="text-sm text-gray-600 dark:text-gray-400"></span>
                        <button onclick="logout()" class="text-sm text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">登出</button>
                    </div>
                </div>
            </div>
        </nav>

        <div class="max-w-4xl mx-auto p-6">
            <!-- 學生資料載入中 -->
            <div id="studentDataLoading" class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 text-center">
                <div class="loading mx-auto mb-4"></div>
                <p>載入您的資料中...</p>
            </div>

            <!-- 學生未註冊 -->
            <div id="studentNotRegistered" class="hidden bg-yellow-50 dark:bg-yellow-900 border border-yellow-200 dark:border-yellow-700 rounded-lg p-6 text-center">
                <i class="fas fa-exclamation-triangle text-yellow-500 text-4xl mb-4"></i>
                <h2 class="text-xl font-bold mb-2">帳號未註冊</h2>
                <p class="text-gray-700 dark:text-gray-300">您的 Google 帳號尚未在系統中註冊，請聯繫管理員添加您的資料。</p>
            </div>

            <!-- 照片顯示區域 -->
            <div id="studentPhotoSection" class="hidden bg-white dark:bg-gray-800 rounded-lg shadow p-6 mb-6">
                <h2 class="text-2xl font-bold mb-4">您的照片</h2>
                <div id="studentPhotoContainer" class="flex justify-center mb-6">
                    <img id="studentPhoto" src="" alt="學生照片" class="max-w-xs max-h-80 rounded-lg shadow-lg">
                </div>
                
                <!-- 照片確認 -->
                <div id="photoConfirmSection" class="text-center mb-6">
                    <p class="text-lg mb-4">請確認這是您本人的照片：</p>
                    <div class="flex justify-center space-x-4">
                        <button onclick="confirmPhoto(true)" class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-lg">
                            <i class="fas fa-check mr-2"></i>確認是我的照片
                        </button>
                        <button onclick="confirmPhoto(false)" class="bg-red-500 hover:bg-red-600 text-white px-6 py-2 rounded-lg">
                            <i class="fas fa-times mr-2"></i>這不是我的照片
                        </button>
                    </div>
                </div>

                <!-- 已確認狀態 -->
                <div id="photoConfirmed" class="hidden text-center mb-6">
                    <div class="inline-flex items-center px-4 py-2 bg-green-100 dark:bg-green-800 text-green-800 dark:text-green-100 rounded-lg">
                        <i class="fas fa-check-circle mr-2"></i>
                        <span>照片已確認</span>
                    </div>
                </div>
            </div>

            <!-- 訂購區域 -->
            <div id="orderSection" class="hidden bg-white dark:bg-gray-800 rounded-lg shadow p-6 mb-6">
                <h2 class="text-2xl font-bold mb-4">訂購選項</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div class="border dark:border-gray-600 rounded-lg p-4 hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer transition-colors" onclick="selectOrder(1)">
                        <div class="flex items-center mb-2">
                            <input type="radio" name="orderOption" value="1" class="mr-2">
                            <h3 class="text-lg font-semibold">1打照片</h3>
                        </div>
                        <p class="text-2xl font-bold text-green-600">$<span id="price1">13</span></p>
                    </div>
                    <div class="border dark:border-gray-600 rounded-lg p-4 hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer transition-colors" onclick="selectOrder(2)">
                        <div class="flex items-center mb-2">
                            <input type="radio" name="orderOption" value="2" class="mr-2">
                            <h3 class="text-lg font-semibold">2打照片</h3>
                        </div>
                        <p class="text-2xl font-bold text-green-600">$<span id="price2">20</span></p>
                    </div>
                </div>
            </div>

            <!-- 簽名區域 -->
            <div id="signatureSection" class="hidden bg-white dark:bg-gray-800 rounded-lg shadow p-6 mb-6">
                <h2 class="text-2xl font-bold mb-4">電子簽名</h2>
                <p class="text-gray-600 dark:text-gray-400 mb-4">請在下方簽名確認您的訂購：</p>
                <canvas id="signatureCanvas" class="signature-pad bg-gray-50 dark:bg-gray-700 rounded-lg w-full h-40 mb-4"></canvas>
                <div class="flex space-x-4">
                    <button onclick="clearSignature()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">
                        <i class="fas fa-eraser mr-2"></i>清除簽名
                    </button>
                    <button onclick="submitOrder()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg" id="submitBtn">
                        <i class="fas fa-paper-plane mr-2"></i>提交訂單
                    </button>
                </div>
            </div>

            <!-- 已提交訂單 -->
            <div id="orderSubmitted" class="hidden bg-blue-50 dark:bg-blue-900 border border-blue-200 dark:border-blue-700 rounded-lg p-6 text-center">
                <i class="fas fa-clock text-blue-500 text-4xl mb-4"></i>
                <h2 class="text-xl font-bold mb-2">訂單已提交</h2>
                <p class="text-gray-700 dark:text-gray-300">您的訂單正在處理中，感謝您的訂購！</p>
            </div>

            <!-- 完成訊息 -->
            <div id="completionMessage" class="hidden bg-green-50 dark:bg-green-900 border border-green-200 dark:border-green-700 rounded-lg p-6 text-center">
                <i class="fas fa-check-circle text-green-500 text-6xl mb-4"></i>
                <h2 class="text-2xl font-bold text-green-800 dark:text-green-200 mb-2">訂單提交成功！</h2>
                <p class="text-green-700 dark:text-green-300">感謝您的訂購，我們會盡快處理您的訂單。</p>
            </div>
        </div>
    </div>

    <!-- 管理員頁面 -->
    <div id="adminPage" class="hidden min-h-screen bg-gray-50 dark:bg-gray-900">
        <!-- 導航欄 -->
        <nav class="bg-white dark:bg-gray-800 shadow-sm">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16">
                    <div class="flex items-center">
                        <h1 class="text-xl font-semibold">管理員控制台</h1>
                    </div>
                    <div class="flex items-center space-x-4">
                        <img id="adminAvatar" src="" alt="頭像" class="w-8 h-8 rounded-full">
                        <span class="text-sm text-gray-600 dark:text-gray-400">管理員</span>
                        <button onclick="logout()" class="text-sm text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">登出</button>
                    </div>
                </div>
            </div>
        </nav>

        <div class="max-w-7xl mx-auto p-6">
            <!-- 標籤頁 -->
            <div class="mb-6">
                <div class="border-b border-gray-200 dark:border-gray-700">
                    <nav class="-mb-px flex space-x-8">
                        <button onclick="switchTab('upload')" class="admin-tab active py-2 px-1 border-b-2 border-blue-500 font-medium text-sm text-blue-600 dark:text-blue-400">
                            <i class="fas fa-upload mr-2"></i>上傳學生資料
                        </button>
                        <button onclick="switchTab('pricing')" class="admin-tab py-2 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300">
                            <i class="fas fa-dollar-sign mr-2"></i>價格設定
                        </button>
                        <button onclick="switchTab('orders')" class="admin-tab py-2 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300">
                            <i class="fas fa-shopping-cart mr-2"></i>訂單管理
                        </button>
                    </nav>
                </div>
            </div>

            <!-- 上傳學生資料標籤 -->
            <div id="uploadTab" class="admin-tab-content">
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                    <h2 class="text-2xl font-bold mb-4">上傳學生資料</h2>
                    <form id="studentForm" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">班別</label>
                                <input type="text" id="studentClass" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base" placeholder="例：6A" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">學號</label>
                                <input type="text" id="studentId" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base" placeholder="例：123456" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">姓名</label>
                                <input type="text" id="studentNameInput" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base" placeholder="學生姓名" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Google 帳號</label>
                                <input type="email" id="studentEmail" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base" placeholder="student@example.com" required>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">學生照片</label>
                            <input type="file" id="studentPhotoInput" accept="image/*" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base" required>
                        </div>
                        <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg font-medium" id="addStudentBtn">
                            <i class="fas fa-plus mr-2"></i>新增學生資料
                        </button>
                    </form>
                </div>
            </div>

            <!-- 價格設定標籤 -->
            <div id="pricingTab" class="admin-tab-content hidden">
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                    <h2 class="text-2xl font-bold mb-4">價格設定</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium mb-2">1打照片價格 ($)</label>
                            <input type="number" id="price1Input" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base" value="13" min="0">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">2打照片價格 ($)</label>
                            <input type="number" id="price2Input" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base" value="20" min="0">
                        </div>
                    </div>
                    <button onclick="updatePricing()" class="mt-4 bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-lg font-medium" id="updatePriceBtn">
                        <i class="fas fa-save mr-2"></i>更新價格
                    </button>
                </div>
            </div>

            <!-- 訂單管理標籤 -->
            <div id="ordersTab" class="admin-tab-content hidden">
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold">訂單管理</h2>
                        <button onclick="downloadOrders()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg">
                            <i class="fas fa-download mr-2"></i>下載訂單資料
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                            <thead class="bg-gray-50 dark:bg-gray-700">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">學生</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">照片確認</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">訂購數量</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">價格</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">時間</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">簽名</th>
                                </tr>
                            </thead>
                            <tbody id="ordersTableBody" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 深色模式偵測
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // 全局變數
        let currentUser = null;
        let currentStudent = null;
        let pricing = { price1: 13, price2: 20 };
        let isDrawing = false;
        let signatureCanvas = null;
        let signatureCtx = null;

        // 管理員郵箱列表 - 請根據需要修改
        const adminEmails = ['ndcsows@ndc.edu.hk'];

        // 初始化應用程式
        window.addEventListener('load', function() {
            setTimeout(() => {
                if (window.firebaseAuth) {
                    initializeApp();
                } else {
                    console.error('Firebase 未正確載入');
                    showAlert('系統初始化失敗，請重新整理頁面');
                }
            }, 1000);
        });

        function initializeApp() {
            onAuthStateChanged(firebaseAuth, (user) => {
                document.getElementById('loadingScreen').classList.add('hidden');
                if (user) {
                    currentUser = user;
                    checkUserRole(user);
                } else {
                    showLoginPage();
                }
            });
            
            loadPricing();
        }

        // Google 登入
        async function signInWithGoogle() {
            try {
                const result = await signInWithPopup(firebaseAuth, provider);
                currentUser = result.user;
            } catch (error) {
                console.error('登入失敗:', error);
                showAlert('登入失敗，請重試');
            }
        }

        // 檢查用戶角色
        async function checkUserRole(user) {
            const email = user.email;
            
            if (adminEmails.includes(email)) {
                showAdminPage();
            } else {
                const studentDoc = await getDoc(doc(firebaseDB, 'students', email));
                if (studentDoc.exists()) {
                    currentStudent = studentDoc.data();
                    showStudentPage();
                } else {
                    showStudentNotRegistered();
                }
            }
        }

        // 顯示頁面
        function showLoginPage() {
            hideAllPages();
            document.getElementById('loginPage').classList.remove('hidden');
        }

        function showStudentPage() {
            hideAllPages();
            document.getElementById('studentPage').classList.remove('hidden');
            
            document.getElementById('userAvatar').src = currentUser.photoURL || '';
            document.getElementById('studentName').textContent = currentStudent.name;
            
            loadStudentData();
        }

        function showStudentNotRegistered() {
            hideAllPages();
            document.getElementById('studentPage').classList.remove('hidden');
            
            document.getElementById('userAvatar').src = currentUser.photoURL || '';
            document.getElementById('studentName').textContent = currentUser.displayName || currentUser.email;
            
            document.getElementById('studentDataLoading').classList.add('hidden');
            document.getElementById('studentNotRegistered').classList.remove('hidden');
        }

        function showAdminPage() {
            hideAllPages();
            document.getElementById('adminPage').classList.remove('hidden');
            
            document.getElementById('adminAvatar').src = currentUser.photoURL || '';
            
            loadPricingForAdmin();
            loadOrdersForAdmin();
        }

        function hideAllPages() {
            document.getElementById('loadingScreen').classList.add('hidden');
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('studentPage').classList.add('hidden');
            document.getElementById('adminPage').classList.add('hidden');
        }

        // 學生頁面功能
        async function loadStudentData() {
            try {
                // 載入價格
                await loadPricing();
                document.getElementById('price1').textContent = pricing.price1;
                document.getElementById('price2').textContent = pricing.price2;
                
                // 顯示學生照片
                document.getElementById('studentPhoto').src = currentStudent.photoUrl;
                
                // 檢查是否已經提交訂單
                const orderQuery = query(
                    collection(firebaseDB, 'orders'),
                    where('studentEmail', '==', currentUser.email)
                );
                const orderSnapshot = await getDocs(orderQuery);
                
                if (!orderSnapshot.empty) {
                    // 已有訂單
                    document.getElementById('studentDataLoading').classList.add('hidden');
                    document.getElementById('orderSubmitted').classList.remove('hidden');
                } else {
                    // 顯示照片和訂購界面
                    document.getElementById('studentDataLoading').classList.add('hidden');
                    document.getElementById('studentPhotoSection').classList.remove('hidden');
                }
            } catch (error) {
                console.error('載入學生資料失敗:', error);
                showAlert('載入資料失敗');
            }
        }

        async function loadPricing() {
            try {
                const pricingDoc = await getDoc(doc(firebaseDB, 'settings', 'pricing'));
                if (pricingDoc.exists()) {
                    pricing = pricingDoc.data();
                }
            } catch (error) {
                console.error('載入價格失敗:', error);
            }
        }

        function confirmPhoto(isCorrect) {
            if (isCorrect) {
                document.getElementById('photoConfirmSection').classList.add('hidden');
                document.getElementById('photoConfirmed').classList.remove('hidden');
                document.getElementById('orderSection').classList.remove('hidden');
            } else {
                showAlert('請聯繫管理員更正您的照片');
            }
        }

        function selectOrder(option) {
            const radio = document.querySelector(`input[value="${option}"]`);
            radio.checked = true;
            document.getElementById('signatureSection').classList.remove('hidden');
            initializeSignature();
        }

        // 簽名功能
        function initializeSignature() {
            signatureCanvas = document.getElementById('signatureCanvas');
            signatureCtx = signatureCanvas.getContext('2d');
            
            const rect = signatureCanvas.getBoundingClientRect();
            signatureCanvas.width = rect.width;
            signatureCanvas.height = rect.height;
            
            signatureCanvas.addEventListener('mousedown', startDrawing);
            signatureCanvas.addEventListener('mousemove', draw);
            signatureCanvas.addEventListener('mouseup', stopDrawing);
            signatureCanvas.addEventListener('touchstart', handleTouch);
            signatureCanvas.addEventListener('touchmove', handleTouch);
            signatureCanvas.addEventListener('touchend', stopDrawing);
        }

        function startDrawing(e) {
            isDrawing = true;
            const rect = signatureCanvas.getBoundingClientRect();
            signatureCtx.beginPath();
            signatureCtx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
        }

        function draw(e) {
            if (!isDrawing) return;
            const rect = signatureCanvas.getBoundingClientRect();
            signatureCtx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
            signatureCtx.stroke();
        }

        function handleTouch(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent(e.type === 'touchstart' ? 'mousedown' : 
                                            e.type === 'touchmove' ? 'mousemove' : 'mouseup', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            signatureCanvas.dispatchEvent(mouseEvent);
        }

        function stopDrawing() {
            isDrawing = false;
        }

        function clearSignature() {
            signatureCtx.clearRect(0, 0, signatureCanvas.width, signatureCanvas.height);
        }

        // 提交訂單
        async function submitOrder() {
            const selectedOption = document.querySelector('input[name="orderOption"]:checked');
            if (!selectedOption) {
                showAlert('請選擇訂購選項');
                return;
            }
            
            const imageData = signatureCtx.getImageData(0, 0, signatureCanvas.width, signatureCanvas.height);
            const hasSignature = imageData.data.some(channel => channel !== 0);
            
            if (!hasSignature) {
                showAlert('請先簽名');
                return;
            }
            
            try {
                document.getElementById('submitBtn').innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>提交中...';
                document.getElementById('submitBtn').disabled = true;
                
                const order = {
                    studentEmail: currentUser.email,
                    studentName: currentStudent.name,
                    studentClass: currentStudent.class,
                    studentId: currentStudent.id,
                    photoConfirmed: true,
                    quantity: selectedOption.value === '1' ? '1打' : '2打',
                    price: selectedOption.value === '1' ? pricing.price1 : pricing.price2,
                    signature: signatureCanvas.toDataURL(),
                    timestamp: new Date().toISOString(),
                    createdAt: new Date()
                };
                
                await addDoc(collection(firebaseDB, 'orders'), order);
                
                document.getElementById('studentPhotoSection').classList.add('hidden');
                document.getElementById('orderSection').classList.add('hidden');
                document.getElementById('signatureSection').classList.add('hidden');
                document.getElementById('completionMessage').classList.remove('hidden');
                
            } catch (error) {
                console.error('提交訂單失敗:', error);
                showAlert('提交失敗，請重試');
                document.getElementById('submitBtn').innerHTML = '<i class="fas fa-paper-plane mr-2"></i>提交訂單';
                document.getElementById('submitBtn').disabled = false;
            }
        }

        // 管理員功能
        document.getElementById('studentForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const studentClass = document.getElementById('studentClass').value;
            const studentId = document.getElementById('studentId').value;
            const studentName = document.getElementById('studentNameInput').value;
            const studentEmail = document.getElementById('studentEmail').value;
            const photoFile = document.getElementById('studentPhotoInput').files[0];
            
            if (!photoFile) {
                showAlert('請選擇學生照片');
                return;
            }
            
            try {
                document.getElementById('addStudentBtn').innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>上傳中...';
                document.getElementById('addStudentBtn').disabled = true;
                
                // 上傳照片到 Firebase Storage
                const photoRef = ref(firebaseStorage, `student-photos/${studentEmail}`);
                await uploadBytes(photoRef, photoFile);
                const photoUrl = await getDownloadURL(photoRef);
                
                // 儲存學生資料到 Firestore
                await setDoc(doc(firebaseDB, 'students', studentEmail), {
                    class: studentClass,
                    id: studentId,
                    name: studentName,
                    email: studentEmail,
                    photoUrl: photoUrl,
                    createdAt: new Date()
                });
                
                showAlert('學生資料已新增成功');
                document.getElementById('studentForm').reset();
                
            } catch (error) {
                console.error('新增學生失敗:', error);
                showAlert('新增失敗，請重試');
            } finally {
                document.getElementById('addStudentBtn').innerHTML = '<i class="fas fa-plus mr-2"></i>新增學生資料';
                document.getElementById('addStudentBtn').disabled = false;
            }
        });

        async function loadPricingForAdmin() {
            try {
                await loadPricing();
                document.getElementById('price1Input').value = pricing.price1;
                document.getElementById('price2Input').value = pricing.price2;
            } catch (error) {
                console.error('載入價格失敗:', error);
            }
        }

        async function updatePricing() {
            try {
                document.getElementById('updatePriceBtn').innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>更新中...';
                document.getElementById('updatePriceBtn').disabled = true;
                
                const newPricing = {
                    price1: parseInt(document.getElementById('price1Input').value),
                    price2: parseInt(document.getElementById('price2Input').value)
                };
                
                await setDoc(doc(firebaseDB, 'settings', 'pricing'), newPricing);
                pricing = newPricing;
                
                showAlert('價格已更新成功');
            } catch (error) {
                console.error('更新價格失敗:', error);
                showAlert('更新失敗，請重試');
            } finally {
                document.getElementById('updatePriceBtn').innerHTML = '<i class="fas fa-save mr-2"></i>更新價格';
                document.getElementById('updatePriceBtn').disabled = false;
            }
        }

        async function loadOrdersForAdmin() {
            try {
                const ordersQuery = query(collection(firebaseDB, 'orders'), orderBy('createdAt', 'desc'));
                const ordersSnapshot = await getDocs(ordersQuery);
                
                const tbody = document.getElementById('ordersTableBody');
                tbody.innerHTML = '';
                
                ordersSnapshot.forEach((doc) => {
                    const order = doc.data();
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900 dark:text-gray-100">${order.studentName}</div>
                            <div class="text-sm text-gray-500 dark:text-gray-400">${order.studentClass} - ${order.studentId}</div>
                            <div class="text-sm text-gray-500 dark:text-gray-400">${order.studentEmail}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800 dark:bg-green-800 dark:text-green-100">
                                已確認
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-gray-100">${order.quantity}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-gray-100">$${order.price}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-gray-100">${new Date(order.timestamp).toLocaleString('zh-TW')}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <button onclick="viewSignature('${encodeURIComponent(order.signature)}')" class="text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300">
                                <i class="fas fa-eye mr-1"></i>查看簽名
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('載入訂單失敗:', error);
            }
        }

        function switchTab(tabName) {
            document.querySelectorAll('.admin-tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            document.querySelectorAll('.admin-tab').forEach(tab => {
                tab.classList.remove('active', 'border-blue-500', 'text-blue-600', 'dark:text-blue-400');
                tab.classList.add('border-transparent', 'text-gray-500', 'dark:text-gray-400');
            });
            
            document.getElementById(tabName + 'Tab').classList.remove('hidden');
            
            event.target.classList.add('active', 'border-blue-500', 'text-blue-600', 'dark:text-blue-400');
            event.target.classList.remove('border-transparent', 'text-gray-500', 'dark:text-gray-400');
            
            if (tabName === 'orders') {
                loadOrdersForAdmin();
            }
        }

        function viewSignature(encodedSignature) {
            const signature = decodeURIComponent(encodedSignature);
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-md w-full mx-4">
                    <h3 class="text-lg font-semibold mb-4 text-gray-900 dark:text-gray-100">學生簽名</h3>
                    <img src="${signature}" alt="簽名" class="w-full border border-gray-200 dark:border-gray-600 rounded">
                    <div class="flex justify-end mt-4">
                        <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 bg-gray-500 text-white hover:bg-gray-600 rounded">
                            關閉
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function downloadOrders() {
            try {
                const ordersQuery = query(collection(firebaseDB, 'orders'), orderBy('createdAt', 'desc'));
                const ordersSnapshot = await getDocs(ordersQuery);
                
                const data = [];
                ordersSnapshot.forEach((doc) => {
                    const order = doc.data();
                    data.push({
                        學生姓名: order.studentName,
                        班別: order.studentClass,
                        學號: order.studentId,
                        郵箱: order.studentEmail,
                        照片確認: '已確認',
                        訂購數量: order.quantity,
                        價格: order.price,
                        訂購時間: new Date(order.timestamp).toLocaleString('zh-TW')
                    });
                });
                
                const csv = convertToCSV(data);
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = '學生訂單資料.csv';
                link.click();
            } catch (error) {
                console.error('下載失敗:', error);
                showAlert('下載失敗，請重試');
            }
        }

        function convertToCSV(data) {
            if (data.length === 0) return '';
            
            const headers = Object.keys(data[0]);
            const csvContent = [
                headers.join(','),
                ...data.map(row => headers.map(header => `"${row[header]}"`).join(','))
            ].join('\n');
            
            return '\ufeff' + csvContent;
        }

        // 登出
        async function logout() {
            try {
                await signOut(firebaseAuth);
                currentUser = null;
                currentStudent = null;
            } catch (error) {
                console.error('登出失敗:', error);
            }
        }

        function showAlert(message) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4">
                    <p class="text-gray-700 dark:text-gray-300 mb-4">${message}</p>
                    <div class="flex justify-end">
                        <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 bg-blue-500 text-white hover:bg-blue-600 rounded">
                            確定
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
    </script>
</body>
</html>
